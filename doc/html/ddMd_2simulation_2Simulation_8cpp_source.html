<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Simpatico: Simulation.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Simpatico&#160;<span id="projectnumber">v1.0</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_1f5833e5a6ae4f3b158cdaf1cc06a4a1.html">src</a>      </li>
      <li class="navelem"><a class="el" href="dir_107001fb60435eff4b64a3d644cd7650.html">ddMd</a>      </li>
      <li class="navelem"><a class="el" href="dir_4ac8ceaeeeee2ea3ee97c6622d85d7d4.html">simulation</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>ddMd/simulation/Simulation.cpp</h1>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#ifndef DDMD_SIMULATION_CPP</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor">#define DDMD_SIMULATION_CPP</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span>
<a name="l00004"></a>00004 <span class="comment">/*</span>
<a name="l00005"></a>00005 <span class="comment">* Simpatico - Simulation Package for Polymeric and Molecular Liquids</span>
<a name="l00006"></a>00006 <span class="comment">*</span>
<a name="l00007"></a>00007 <span class="comment">* Copyright 2010 - 2012, David Morse (morse012@umn.edu)</span>
<a name="l00008"></a>00008 <span class="comment">* Distributed under the terms of the GNU General Public License.</span>
<a name="l00009"></a>00009 <span class="comment">*/</span>
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 <span class="preprocessor">#include &quot;Simulation.h&quot;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &lt;ddMd/storage/AtomIterator.h&gt;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &lt;ddMd/integrators/Integrator.h&gt;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;ddMd/integrators/IntegratorFactory.h&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;ddMd/configIos/ConfigIo.h&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;ddMd/configIos/ConfigIoFactory.h&gt;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;ddMd/configIos/DdMdConfigIo.h&gt;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;ddMd/util/FileMaster.h&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;ddMd/diagnostics/DiagnosticManager.h&gt;</span>
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="preprocessor">#ifndef DDMD_NOPAIR</span>
<a name="l00022"></a>00022 <span class="preprocessor"></span><span class="preprocessor">#include &lt;ddMd/potentials/pair/PairPotential.h&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;ddMd/potentials/pair/PairPotentialImpl.h&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;ddMd/potentials/pair/PairFactory.h&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#endif</span>
<a name="l00026"></a>00026 <span class="preprocessor"></span><span class="preprocessor">#include &lt;ddMd/potentials/bond/BondPotential.h&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;ddMd/potentials/bond/BondPotentialImpl.h&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;ddMd/potentials/bond/BondFactory.h&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#ifdef INTER_ANGLE</span>
<a name="l00030"></a>00030 <span class="preprocessor"></span><span class="preprocessor">#include &lt;ddMd/potentials/angle/AnglePotential.h&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;ddMd/potentials/angle/AnglePotentialImpl.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;ddMd/potentials/angle/AngleFactory.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#endif</span>
<a name="l00034"></a>00034 <span class="preprocessor"></span><span class="preprocessor">#ifdef INTER_DIHEDRAL</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span><span class="preprocessor">#include &lt;ddMd/potentials/dihedral/DihedralPotential.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;ddMd/potentials/dihedral/DihedralPotentialImpl.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;ddMd/potentials/dihedral/DihedralFactory.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#endif</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span><span class="preprocessor">#ifdef INTER_EXTERNAL</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span><span class="preprocessor">#include &lt;ddMd/potentials/external/ExternalPotential.h&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;ddMd/potentials/external/ExternalPotentialImpl.h&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;ddMd/potentials/external/ExternalFactory.h&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#endif</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span>
<a name="l00045"></a>00045 <span class="comment">// namespace McMd</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;mcMd/mcSimulation/McSimulation.h&gt;</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="comment">// namespace Util</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;util/ensembles/EnergyEnsemble.h&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;util/ensembles/BoundaryEnsemble.h&gt;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;util/space/Vector.h&gt;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &lt;util/space/IntVector.h&gt;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &lt;util/space/Tensor.h&gt;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &lt;util/param/Factory.h&gt;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &lt;util/util/Log.h&gt;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &lt;util/mpi/MpiSendRecv.h&gt;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &lt;util/util/Timer.h&gt;</span>
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="preprocessor">#include &lt;util/format/Int.h&gt;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &lt;util/format/Dbl.h&gt;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &lt;util/format/Str.h&gt;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &lt;util/util/ioUtil.h&gt;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &lt;util/util/initStatic.h&gt;</span>
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="preprocessor">#include &lt;fstream&gt;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 <span class="keyword">namespace </span>DdMd
<a name="l00070"></a>00070 {
<a name="l00071"></a>00071 
<a name="l00072"></a>00072    <span class="keyword">using namespace </span>Util;
<a name="l00073"></a>00073 
<a name="l00074"></a>00074    <span class="comment">/*</span>
<a name="l00075"></a>00075 <span class="comment">   * Constructor.</span>
<a name="l00076"></a>00076 <span class="comment">   */</span>
<a name="l00077"></a>00077 <span class="preprocessor">   #ifdef UTIL_MPI</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span>   <a class="code" href="classDdMd_1_1Simulation.html#a0e5546137dca89bb96077da6e2af3103" title="Default constructor.">Simulation::Simulation</a>(MPI::Intracomm&amp; communicator)
<a name="l00079"></a><a class="code" href="classDdMd_1_1Simulation.html#a0e5546137dca89bb96077da6e2af3103">00079</a>    <span class="preprocessor">#else</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span>   <a class="code" href="classDdMd_1_1Simulation.html#a0e5546137dca89bb96077da6e2af3103" title="Default constructor.">Simulation::Simulation</a>() 
<a name="l00081"></a>00081    <span class="preprocessor">#endif</span>
<a name="l00082"></a>00082 <span class="preprocessor"></span>    : atomStorage_(),
<a name="l00083"></a>00083       bondStorage_(),
<a name="l00084"></a>00084 <span class="preprocessor">      #ifdef INTER_ANGLE</span>
<a name="l00085"></a>00085 <span class="preprocessor"></span>      angleStorage_(),
<a name="l00086"></a>00086 <span class="preprocessor">      #endif</span>
<a name="l00087"></a>00087 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_DIHEDRAL</span>
<a name="l00088"></a>00088 <span class="preprocessor"></span>      dihedralStorage_(),
<a name="l00089"></a>00089 <span class="preprocessor">      #endif</span>
<a name="l00090"></a>00090 <span class="preprocessor"></span>      boundary_(),
<a name="l00091"></a>00091       atomTypes_(),
<a name="l00092"></a>00092       domain_(),
<a name="l00093"></a>00093       buffer_(),
<a name="l00094"></a>00094       exchanger_(),
<a name="l00095"></a>00095       random_(),
<a name="l00096"></a>00096       maxBoundary_(),
<a name="l00097"></a>00097       kineticEnergy_(0.0),
<a name="l00098"></a>00098       pairPotentialPtr_(0),
<a name="l00099"></a>00099       bondPotentialPtr_(0),
<a name="l00100"></a>00100 <span class="preprocessor">      #ifdef INTER_ANGLE</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span>      anglePotentialPtr_(0),
<a name="l00102"></a>00102 <span class="preprocessor">      #endif</span>
<a name="l00103"></a>00103 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_DIHEDRAL</span>
<a name="l00104"></a>00104 <span class="preprocessor"></span>      dihedralPotentialPtr_(0),
<a name="l00105"></a>00105 <span class="preprocessor">      #endif</span>
<a name="l00106"></a>00106 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_EXTERNAL</span>
<a name="l00107"></a>00107 <span class="preprocessor"></span>      externalPotentialPtr_(0),
<a name="l00108"></a>00108 <span class="preprocessor">      #endif</span>
<a name="l00109"></a>00109 <span class="preprocessor"></span>      integratorPtr_(0),
<a name="l00110"></a>00110       energyEnsemblePtr_(0),
<a name="l00111"></a>00111       boundaryEnsemblePtr_(0),
<a name="l00112"></a>00112       fileMasterPtr_(0),
<a name="l00113"></a>00113       configIoPtr_(0),
<a name="l00114"></a>00114       diagnosticManagerPtr_(0),
<a name="l00115"></a>00115 <span class="preprocessor">      #ifndef DDMD_NOPAIR</span>
<a name="l00116"></a>00116 <span class="preprocessor"></span>      pairFactoryPtr_(0),
<a name="l00117"></a>00117 <span class="preprocessor">      #endif</span>
<a name="l00118"></a>00118 <span class="preprocessor"></span>      bondFactoryPtr_(0),
<a name="l00119"></a>00119 <span class="preprocessor">      #ifdef INTER_ANGLE</span>
<a name="l00120"></a>00120 <span class="preprocessor"></span>      angleFactoryPtr_(0),
<a name="l00121"></a>00121 <span class="preprocessor">      #endif</span>
<a name="l00122"></a>00122 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_DIHEDRAL</span>
<a name="l00123"></a>00123 <span class="preprocessor"></span>      dihedralFactoryPtr_(0),
<a name="l00124"></a>00124 <span class="preprocessor">      #endif</span>
<a name="l00125"></a>00125 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_EXTERNAL</span>
<a name="l00126"></a>00126 <span class="preprocessor"></span>      externalFactoryPtr_(0),
<a name="l00127"></a>00127 <span class="preprocessor">      #endif</span>
<a name="l00128"></a>00128 <span class="preprocessor"></span>      integratorFactoryPtr_(0),
<a name="l00129"></a>00129       configIoFactoryPtr_(0),
<a name="l00130"></a>00130 <span class="preprocessor">      #ifndef DDMD_NOPAIR</span>
<a name="l00131"></a>00131 <span class="preprocessor"></span>      pairStyle_(),
<a name="l00132"></a>00132 <span class="preprocessor">      #endif</span>
<a name="l00133"></a>00133 <span class="preprocessor"></span>      bondStyle_(),
<a name="l00134"></a>00134 <span class="preprocessor">      #ifdef INTER_ANGLE</span>
<a name="l00135"></a>00135 <span class="preprocessor"></span>      angleStyle_(),
<a name="l00136"></a>00136 <span class="preprocessor">      #endif</span>
<a name="l00137"></a>00137 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_DIHEDRAL</span>
<a name="l00138"></a>00138 <span class="preprocessor"></span>      dihedralStyle_(),
<a name="l00139"></a>00139 <span class="preprocessor">      #endif</span>
<a name="l00140"></a>00140 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_EXTERNAL</span>
<a name="l00141"></a>00141 <span class="preprocessor"></span>      externalStyle_(),
<a name="l00142"></a>00142 <span class="preprocessor">      #endif</span>
<a name="l00143"></a>00143 <span class="preprocessor"></span>      nAtomType_(0),
<a name="l00144"></a>00144       nBondType_(0),
<a name="l00145"></a>00145 <span class="preprocessor">      #ifdef INTER_ANGLE</span>
<a name="l00146"></a>00146 <span class="preprocessor"></span>      nAngleType_(0),
<a name="l00147"></a>00147 <span class="preprocessor">      #endif</span>
<a name="l00148"></a>00148 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_DIHEDRAL</span>
<a name="l00149"></a>00149 <span class="preprocessor"></span>      nDihedralType_(0),
<a name="l00150"></a>00150 <span class="preprocessor">      #endif</span>
<a name="l00151"></a>00151 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_EXTERNAL</span>
<a name="l00152"></a>00152 <span class="preprocessor"></span>      hasExternal_(<span class="keyword">false</span>),
<a name="l00153"></a>00153 <span class="preprocessor">      #endif</span>
<a name="l00154"></a>00154 <span class="preprocessor"></span>      maskedPairPolicy_(MaskBonded),
<a name="l00155"></a>00155       reverseUpdateFlag_(<span class="keyword">false</span>)
<a name="l00156"></a>00156       <span class="preprocessor">#ifdef UTIL_MPI</span>
<a name="l00157"></a>00157 <span class="preprocessor"></span>      , communicator_(communicator)
<a name="l00158"></a>00158       <span class="preprocessor">#endif</span>
<a name="l00159"></a>00159 <span class="preprocessor"></span>   {
<a name="l00160"></a>00160       <a class="code" href="namespaceUtil.html#ae378e26a0d525f0cdeb424f208724608" title="Guarantee initialization of all static class members in Util namespace.">Util::initStatic</a>();
<a name="l00161"></a>00161 
<a name="l00162"></a>00162 <span class="preprocessor">      #ifdef UTIL_MPI</span>
<a name="l00163"></a>00163 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (!MPI::Is_initialized()) {
<a name="l00164"></a>00164          <a class="code" href="global_8h.html#ad2512f8bd062d41d66799cf900151487" title="Macro for throwing an Exception, reporting function, file and line number.">UTIL_THROW</a>(<span class="stringliteral">&quot;MPI is not initialized&quot;</span>);
<a name="l00165"></a>00165       }
<a name="l00166"></a>00166       <a class="code" href="classUtil_1_1Vector.html#a318292420f45f49eb52592c0d74610dc" title="Commit MPI datatype MpiTraits&amp;lt;Vector&amp;gt;::type.">Util::Vector::commitMpiType</a>();
<a name="l00167"></a>00167       <a class="code" href="classUtil_1_1IntVector.html#ad54c107285d35edd9dc957b1f77324a1" title="Commit MPI datatype MpiTraits&amp;lt;IntVector&amp;gt;::type.">Util::IntVector::commitMpiType</a>();
<a name="l00168"></a>00168       <a class="code" href="classDdMd_1_1AtomType.html#a4ca212565c76960568a0b9126071e495" title="Call this to guarantee initialization of static data.">AtomType::initStatic</a>();
<a name="l00169"></a>00169 
<a name="l00170"></a>00170       setParamCommunicator(communicator);
<a name="l00171"></a>00171       domain_.setGridCommunicator(communicator);
<a name="l00172"></a>00172 <span class="preprocessor">      #else</span>
<a name="l00173"></a>00173 <span class="preprocessor"></span>      domain_.setRank(0);
<a name="l00174"></a>00174 <span class="preprocessor">      #endif</span>
<a name="l00175"></a>00175 <span class="preprocessor"></span>
<a name="l00176"></a>00176       <span class="comment">// Set connections between member objects</span>
<a name="l00177"></a>00177       domain_.setBoundary(boundary_);
<a name="l00178"></a>00178       exchanger_.associate(domain_, boundary_,
<a name="l00179"></a>00179                            atomStorage_, bondStorage_, 
<a name="l00180"></a>00180                            #ifdef INTER_ANGLE
<a name="l00181"></a>00181                            angleStorage_,
<a name="l00182"></a>00182                            #endif
<a name="l00183"></a>00183                            #ifdef INTER_DIHEDRAL
<a name="l00184"></a>00184                            dihedralStorage_,
<a name="l00185"></a>00185                            #endif
<a name="l00186"></a>00186                            buffer_);
<a name="l00187"></a>00187 
<a name="l00188"></a>00188       fileMasterPtr_ = <span class="keyword">new</span> <a class="code" href="classDdMd_1_1FileMaster.html" title="A FileMaster manages a set of input and output files.">FileMaster</a>;
<a name="l00189"></a>00189       energyEnsemblePtr_  = <span class="keyword">new</span> <a class="code" href="classUtil_1_1EnergyEnsemble.html" title="A statistical ensemble for energy.">EnergyEnsemble</a>;
<a name="l00190"></a>00190       boundaryEnsemblePtr_ = <span class="keyword">new</span> <a class="code" href="classUtil_1_1BoundaryEnsemble.html" title="Statistical ensemble for changes in the periodic unit cell size.">BoundaryEnsemble</a>;
<a name="l00191"></a>00191      
<a name="l00192"></a>00192       diagnosticManagerPtr_ = <span class="keyword">new</span> <a class="code" href="classDdMd_1_1DiagnosticManager.html" title="Manager for a list of Diagnostic objects.">DiagnosticManager</a>(*<span class="keyword">this</span>);
<a name="l00193"></a>00193    }
<a name="l00194"></a>00194 
<a name="l00195"></a>00195    <span class="comment">/*</span>
<a name="l00196"></a>00196 <span class="comment">   * Destructor.</span>
<a name="l00197"></a>00197 <span class="comment">   */</span>
<a name="l00198"></a>00198    <a class="code" href="classDdMd_1_1Simulation.html#a2a3bc93d0f5586bbde035256520d45bd" title="Destructor.">Simulation::~Simulation</a>()
<a name="l00199"></a><a class="code" href="classDdMd_1_1Simulation.html#a2a3bc93d0f5586bbde035256520d45bd">00199</a>    {
<a name="l00200"></a>00200       <span class="keywordflow">if</span> (pairPotentialPtr_) {
<a name="l00201"></a>00201          <span class="keyword">delete</span> pairPotentialPtr_;
<a name="l00202"></a>00202       }
<a name="l00203"></a>00203       <span class="keywordflow">if</span> (bondPotentialPtr_) {
<a name="l00204"></a>00204          <span class="keyword">delete</span> bondPotentialPtr_;
<a name="l00205"></a>00205       }
<a name="l00206"></a>00206 <span class="preprocessor">      #ifdef INTER_ANGLE</span>
<a name="l00207"></a>00207 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (anglePotentialPtr_) {
<a name="l00208"></a>00208          <span class="keyword">delete</span> anglePotentialPtr_;
<a name="l00209"></a>00209       }
<a name="l00210"></a>00210 <span class="preprocessor">      #endif</span>
<a name="l00211"></a>00211 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_DIHEDRAL</span>
<a name="l00212"></a>00212 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (dihedralPotentialPtr_) {
<a name="l00213"></a>00213          <span class="keyword">delete</span> dihedralPotentialPtr_;
<a name="l00214"></a>00214       }
<a name="l00215"></a>00215 <span class="preprocessor">      #endif</span>
<a name="l00216"></a>00216 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_EXTERNAL</span>
<a name="l00217"></a>00217 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (externalPotentialPtr_) {
<a name="l00218"></a>00218          <span class="keyword">delete</span> externalPotentialPtr_;
<a name="l00219"></a>00219       }
<a name="l00220"></a>00220 <span class="preprocessor">      #endif</span>
<a name="l00221"></a>00221 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (energyEnsemblePtr_) {
<a name="l00222"></a>00222          <span class="keyword">delete</span> energyEnsemblePtr_;
<a name="l00223"></a>00223       }
<a name="l00224"></a>00224       <span class="keywordflow">if</span> (boundaryEnsemblePtr_) {
<a name="l00225"></a>00225          <span class="keyword">delete</span> boundaryEnsemblePtr_;
<a name="l00226"></a>00226       }
<a name="l00227"></a>00227       <span class="keywordflow">if</span> (integratorPtr_) {
<a name="l00228"></a>00228          <span class="keyword">delete</span> integratorPtr_;
<a name="l00229"></a>00229       }
<a name="l00230"></a>00230       <span class="keywordflow">if</span> (fileMasterPtr_) {
<a name="l00231"></a>00231          <span class="keyword">delete</span> fileMasterPtr_;
<a name="l00232"></a>00232       }
<a name="l00233"></a>00233       <span class="keywordflow">if</span> (configIoPtr_) {
<a name="l00234"></a>00234          <span class="keyword">delete</span> configIoPtr_;
<a name="l00235"></a>00235       }
<a name="l00236"></a>00236       <span class="keywordflow">if</span> (diagnosticManagerPtr_) {
<a name="l00237"></a>00237          <span class="keyword">delete</span> diagnosticManagerPtr_;
<a name="l00238"></a>00238       }
<a name="l00239"></a>00239 <span class="preprocessor">      #ifndef DDMD_NOPAIR</span>
<a name="l00240"></a>00240 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (pairFactoryPtr_) {
<a name="l00241"></a>00241          <span class="keyword">delete</span> pairFactoryPtr_;
<a name="l00242"></a>00242       }
<a name="l00243"></a>00243 <span class="preprocessor">      #endif</span>
<a name="l00244"></a>00244 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (bondFactoryPtr_) {
<a name="l00245"></a>00245          <span class="keyword">delete</span> bondFactoryPtr_;
<a name="l00246"></a>00246       }
<a name="l00247"></a>00247 <span class="preprocessor">      #ifdef INTER_ANGLE</span>
<a name="l00248"></a>00248 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (angleFactoryPtr_) {
<a name="l00249"></a>00249          <span class="keyword">delete</span> angleFactoryPtr_;
<a name="l00250"></a>00250       }
<a name="l00251"></a>00251 <span class="preprocessor">      #endif</span>
<a name="l00252"></a>00252 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_DIHEDRAL</span>
<a name="l00253"></a>00253 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (dihedralFactoryPtr_) {
<a name="l00254"></a>00254          <span class="keyword">delete</span> dihedralFactoryPtr_;
<a name="l00255"></a>00255       }
<a name="l00256"></a>00256 <span class="preprocessor">      #endif</span>
<a name="l00257"></a>00257 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_EXTERNAL</span>
<a name="l00258"></a>00258 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (externalFactoryPtr_) {
<a name="l00259"></a>00259          <span class="keyword">delete</span> externalFactoryPtr_;
<a name="l00260"></a>00260       }
<a name="l00261"></a>00261 <span class="preprocessor">      #endif</span>
<a name="l00262"></a>00262 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (integratorFactoryPtr_) {
<a name="l00263"></a>00263          <span class="keyword">delete</span> integratorFactoryPtr_;
<a name="l00264"></a>00264       }
<a name="l00265"></a>00265       <span class="keywordflow">if</span> (configIoFactoryPtr_) {
<a name="l00266"></a>00266          <span class="keyword">delete</span> configIoFactoryPtr_;
<a name="l00267"></a>00267       }
<a name="l00268"></a>00268 
<a name="l00269"></a>00269 <span class="preprocessor">      #ifdef UTIL_MPI</span>
<a name="l00270"></a>00270 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (logFile_.is_open()) logFile_.close();
<a name="l00271"></a>00271 <span class="preprocessor">      #endif</span>
<a name="l00272"></a>00272 <span class="preprocessor"></span>   }
<a name="l00273"></a>00273 
<a name="l00274"></a>00274    <span class="comment">/*</span>
<a name="l00275"></a>00275 <span class="comment">   * Process command line options.</span>
<a name="l00276"></a>00276 <span class="comment">   */</span>
<a name="l00277"></a>00277    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#aca76be0b3b11bd4c3499b5513102cbfc" title="Process command line options.">Simulation::setOptions</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l00278"></a><a class="code" href="classDdMd_1_1Simulation.html#aca76be0b3b11bd4c3499b5513102cbfc">00278</a>    {
<a name="l00279"></a>00279       <span class="keywordtype">bool</span>   eFlag = <span class="keyword">false</span>;
<a name="l00280"></a>00280       <span class="keywordtype">bool</span>   sFlag = <span class="keyword">false</span>;
<a name="l00281"></a>00281       <span class="keywordtype">char</span>*  sArg;
<a name="l00282"></a>00282       <span class="keywordtype">int</span>    nSystem = 1;
<a name="l00283"></a>00283    
<a name="l00284"></a>00284       <span class="comment">// Read command-line arguments</span>
<a name="l00285"></a>00285       <span class="keywordtype">int</span> c;
<a name="l00286"></a>00286       opterr = 0;
<a name="l00287"></a>00287       <span class="keywordflow">while</span> ((c = getopt(argc, argv, <span class="stringliteral">&quot;es:&quot;</span>)) != -1) {
<a name="l00288"></a>00288          <span class="keywordflow">switch</span> (c) {
<a name="l00289"></a>00289          <span class="keywordflow">case</span> <span class="charliteral">&#39;e&#39;</span>:
<a name="l00290"></a>00290            eFlag = <span class="keyword">true</span>;
<a name="l00291"></a>00291            <span class="keywordflow">break</span>;
<a name="l00292"></a>00292          <span class="keywordflow">case</span> <span class="charliteral">&#39;s&#39;</span>:
<a name="l00293"></a>00293            sFlag = <span class="keyword">true</span>;
<a name="l00294"></a>00294            sArg  = optarg;
<a name="l00295"></a>00295            nSystem = atoi(sArg);
<a name="l00296"></a>00296            <span class="keywordflow">break</span>;
<a name="l00297"></a>00297          <span class="keywordflow">case</span> <span class="charliteral">&#39;?&#39;</span>:
<a name="l00298"></a>00298            std::cout &lt;&lt; <span class="stringliteral">&quot;Unknown option -&quot;</span> &lt;&lt; optopt &lt;&lt; std::endl;
<a name="l00299"></a>00299          }
<a name="l00300"></a>00300       }
<a name="l00301"></a>00301    
<a name="l00302"></a>00302       <span class="comment">// Enable echoing of parameters to log file as they are read</span>
<a name="l00303"></a>00303       <span class="keywordflow">if</span> (eFlag) {
<a name="l00304"></a>00304          <a class="code" href="classUtil_1_1ParamComponent.html#add72ad7add98e0b90979ee2638c7468d" title="Set echo parameter to true enable echoing, or false to disable.">Util::ParamComponent::setEcho</a>(<span class="keyword">true</span>);
<a name="l00305"></a>00305       }
<a name="l00306"></a>00306 
<a name="l00307"></a>00307       <span class="comment">// Split communicator</span>
<a name="l00308"></a>00308       <span class="keywordflow">if</span> (sFlag) {
<a name="l00309"></a>00309          <span class="keywordflow">if</span> (nSystem &lt;= 1) {
<a name="l00310"></a>00310             <a class="code" href="global_8h.html#ad2512f8bd062d41d66799cf900151487" title="Macro for throwing an Exception, reporting function, file and line number.">UTIL_THROW</a>(<span class="stringliteral">&quot;nSystem must be greater than 1&quot;</span>);
<a name="l00311"></a>00311          }
<a name="l00312"></a>00312          <span class="keywordtype">int</span> worldRank = communicator_.Get_rank();
<a name="l00313"></a>00313          <span class="keywordtype">int</span> worldSize = communicator_.Get_size();
<a name="l00314"></a>00314          <span class="keywordflow">if</span> (worldSize % nSystem != 0) {
<a name="l00315"></a>00315             <a class="code" href="global_8h.html#ad2512f8bd062d41d66799cf900151487" title="Macro for throwing an Exception, reporting function, file and line number.">UTIL_THROW</a>(<span class="stringliteral">&quot;World communicator size is not a multiple of nSystem&quot;</span>);
<a name="l00316"></a>00316          }
<a name="l00317"></a>00317 
<a name="l00318"></a>00318          <span class="comment">// Split the communicator</span>
<a name="l00319"></a>00319          <span class="keywordtype">int</span> systemSize = worldSize/nSystem;
<a name="l00320"></a>00320          <span class="keywordtype">int</span> systemId  = worldRank/systemSize;
<a name="l00321"></a>00321          communicator_ = communicator_.Split(systemId, worldRank);
<a name="l00322"></a>00322 
<a name="l00323"></a>00323 <span class="preprocessor">         #if 0</span>
<a name="l00324"></a>00324 <span class="preprocessor"></span>         std::cout &lt;&lt; worldRank &lt;&lt; <span class="stringliteral">&quot;  &quot;</span> &lt;&lt; systemId &lt;&lt; <span class="stringliteral">&quot;  &quot;</span> 
<a name="l00325"></a>00325                    &lt;&lt; communicator_.Get_rank() &lt;&lt; std::endl;
<a name="l00326"></a>00326 <span class="preprocessor">         #endif</span>
<a name="l00327"></a>00327 <span class="preprocessor"></span>    
<a name="l00328"></a>00328          <span class="comment">// Set param and grid communicators</span>
<a name="l00329"></a>00329          setParamCommunicator(communicator_);
<a name="l00330"></a>00330          domain_.setGridCommunicator(communicator_);
<a name="l00331"></a>00331          fileMaster().setDirectoryId(systemId);
<a name="l00332"></a>00332       
<a name="l00333"></a>00333          <span class="comment">// Set log file for processor n to a new file named &quot;n/log&quot;.</span>
<a name="l00334"></a>00334          <span class="comment">// Relies on initialization of outputPrefix to empty string &quot;&quot;.</span>
<a name="l00335"></a>00335          fileMaster().openOutputFile(<span class="stringliteral">&quot;log&quot;</span>, logFile_);
<a name="l00336"></a>00336          <a class="code" href="classUtil_1_1Log.html#a4d40ebcfa31f857e1cd57734419dbbde" title="Set the log ostream to a file.">Log::setFile</a>(logFile_);
<a name="l00337"></a>00337       }
<a name="l00338"></a>00338    }
<a name="l00339"></a>00339 
<a name="l00340"></a>00340    <span class="comment">/*</span>
<a name="l00341"></a>00341 <span class="comment">   *  Read parameters from default parameter file. </span>
<a name="l00342"></a>00342 <span class="comment">   */</span>
<a name="l00343"></a>00343    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#af7672b513e7f71ad6a19b5c0a040cbb8" title="Read parameters from default parameter file.">Simulation::readParam</a>()
<a name="l00344"></a><a class="code" href="classDdMd_1_1Simulation.html#af7672b513e7f71ad6a19b5c0a040cbb8">00344</a>    {   readParam(fileMaster().paramFile()); }
<a name="l00345"></a>00345 
<a name="l00349"></a>00349    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#af7672b513e7f71ad6a19b5c0a040cbb8" title="Read parameters from default parameter file.">Simulation::readParam</a>(std::istream&amp; in)
<a name="l00350"></a><a class="code" href="classDdMd_1_1Simulation.html#a24277545642a0b701181ffea85613b57">00350</a>    {
<a name="l00351"></a>00351       <span class="comment">// Preconditions</span>
<a name="l00352"></a>00352       assert(pairPotentialPtr_ == 0);
<a name="l00353"></a>00353       assert(bondPotentialPtr_ == 0);
<a name="l00354"></a>00354       assert(integratorPtr_ == 0);
<a name="l00355"></a>00355       assert(configIoPtr_ == 0);
<a name="l00356"></a>00356 
<a name="l00357"></a>00357       readBegin(in, <span class="stringliteral">&quot;Simulation&quot;</span>);
<a name="l00358"></a>00358 
<a name="l00359"></a>00359       readParamComposite(in, domain_);
<a name="l00360"></a>00360 
<a name="l00361"></a>00361       readFileMaster(in);
<a name="l00362"></a>00362 
<a name="l00363"></a>00363       <span class="comment">// Read types</span>
<a name="l00364"></a>00364       read&lt;int&gt;(in, <span class="stringliteral">&quot;nAtomType&quot;</span>, nAtomType_);
<a name="l00365"></a>00365       read&lt;int&gt;(in, <span class="stringliteral">&quot;nBondType&quot;</span>, nBondType_);
<a name="l00366"></a>00366 <span class="preprocessor">      #ifdef INTER_ANGLE</span>
<a name="l00367"></a>00367 <span class="preprocessor"></span>      read&lt;int&gt;(in, <span class="stringliteral">&quot;nAngleType&quot;</span>, nAngleType_);
<a name="l00368"></a>00368 <span class="preprocessor">      #endif</span>
<a name="l00369"></a>00369 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_DIHEDRAL</span>
<a name="l00370"></a>00370 <span class="preprocessor"></span>      read&lt;int&gt;(in, <span class="stringliteral">&quot;nDihedralType&quot;</span>, nDihedralType_);
<a name="l00371"></a>00371 <span class="preprocessor">      #endif</span>
<a name="l00372"></a>00372 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_EXTERNAL</span>
<a name="l00373"></a>00373 <span class="preprocessor"></span>      read&lt;bool&gt;(in, <span class="stringliteral">&quot;hasExternal&quot;</span>, hasExternal_);
<a name="l00374"></a>00374 <span class="preprocessor">      #endif</span>
<a name="l00375"></a>00375 <span class="preprocessor"></span>      atomTypes_.allocate(nAtomType_);
<a name="l00376"></a>00376       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nAtomType_; ++i) {
<a name="l00377"></a>00377          atomTypes_[i].setId(i);
<a name="l00378"></a>00378       }
<a name="l00379"></a>00379       readDArray&lt;AtomType&gt;(in, <span class="stringliteral">&quot;atomTypes&quot;</span>, atomTypes_, nAtomType_);
<a name="l00380"></a>00380 
<a name="l00381"></a>00381       <span class="comment">// Read storage capacities</span>
<a name="l00382"></a>00382       readParamComposite(in, atomStorage_);
<a name="l00383"></a>00383       readParamComposite(in, bondStorage_);
<a name="l00384"></a>00384 <span class="preprocessor">      #ifdef INTER_ANGLE</span>
<a name="l00385"></a>00385 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nAngleType_) {
<a name="l00386"></a>00386          readParamComposite(in, angleStorage_);
<a name="l00387"></a>00387       }
<a name="l00388"></a>00388 <span class="preprocessor">      #endif</span>
<a name="l00389"></a>00389 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_DIHEDRAL</span>
<a name="l00390"></a>00390 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nDihedralType_) {
<a name="l00391"></a>00391          readParamComposite(in, dihedralStorage_);
<a name="l00392"></a>00392       }
<a name="l00393"></a>00393 <span class="preprocessor">      #endif</span>
<a name="l00394"></a>00394 <span class="preprocessor"></span>      readParamComposite(in, buffer_);
<a name="l00395"></a>00395       readPotentialStyles(in);
<a name="l00396"></a>00396 
<a name="l00397"></a>00397 <span class="preprocessor">      #ifndef DDMD_NOPAIR</span>
<a name="l00398"></a>00398 <span class="preprocessor"></span>      <span class="comment">// Pair Potential</span>
<a name="l00399"></a>00399       pairPotentialPtr_ = pairFactory().factory(pairStyle());
<a name="l00400"></a>00400       pairPotentialPtr_-&gt;setNAtomType(nAtomType_);
<a name="l00401"></a>00401       readParamComposite(in, *pairPotentialPtr_);
<a name="l00402"></a>00402       pairPotentialPtr_-&gt;setReverseUpdateFlag(reverseUpdateFlag_);
<a name="l00403"></a>00403 <span class="preprocessor">      #endif</span>
<a name="l00404"></a>00404 <span class="preprocessor"></span>
<a name="l00405"></a>00405       <span class="comment">// Bond Potential</span>
<a name="l00406"></a>00406       bondPotentialPtr_ = bondFactory().factory(bondStyle());
<a name="l00407"></a>00407       bondPotentialPtr_-&gt;setNBondType(nBondType_);
<a name="l00408"></a>00408       readParamComposite(in, *bondPotentialPtr_);
<a name="l00409"></a>00409 
<a name="l00410"></a>00410 <span class="preprocessor">      #ifdef INTER_ANGLE</span>
<a name="l00411"></a>00411 <span class="preprocessor"></span>      <span class="comment">// Angle potential</span>
<a name="l00412"></a>00412       <span class="keywordflow">if</span> (nAngleType_) {
<a name="l00413"></a>00413          anglePotentialPtr_ = angleFactory().factory(angleStyle());
<a name="l00414"></a>00414          anglePotentialPtr_-&gt;setNAngleType(nAngleType_);
<a name="l00415"></a>00415          readParamComposite(in, *anglePotentialPtr_);
<a name="l00416"></a>00416       }
<a name="l00417"></a>00417 <span class="preprocessor">      #endif</span>
<a name="l00418"></a>00418 <span class="preprocessor"></span>
<a name="l00419"></a>00419 <span class="preprocessor">      #ifdef INTER_DIHEDRAL</span>
<a name="l00420"></a>00420 <span class="preprocessor"></span>      <span class="comment">// Dihedral potential</span>
<a name="l00421"></a>00421       <span class="keywordflow">if</span> (nDihedralType_) {
<a name="l00422"></a>00422          dihedralPotentialPtr_ = dihedralFactory().factory(dihedralStyle());
<a name="l00423"></a>00423          dihedralPotentialPtr_-&gt;setNDihedralType(nDihedralType_);
<a name="l00424"></a>00424          readParamComposite(in, *dihedralPotentialPtr_);
<a name="l00425"></a>00425       }
<a name="l00426"></a>00426 <span class="preprocessor">      #endif</span>
<a name="l00427"></a>00427 <span class="preprocessor"></span>
<a name="l00428"></a>00428 <span class="preprocessor">      #ifdef INTER_EXTERNAL</span>
<a name="l00429"></a>00429 <span class="preprocessor"></span>      <span class="comment">// External potential</span>
<a name="l00430"></a>00430       <span class="keywordflow">if</span> (hasExternal_) {
<a name="l00431"></a>00431          externalPotentialPtr_ = externalFactory().factory(externalStyle());
<a name="l00432"></a>00432          externalPotentialPtr_-&gt;setNAtomType(nAtomType_);
<a name="l00433"></a>00433          readParamComposite(in, *externalPotentialPtr_);
<a name="l00434"></a>00434       }
<a name="l00435"></a>00435 <span class="preprocessor">      #endif</span>
<a name="l00436"></a>00436 <span class="preprocessor"></span>
<a name="l00437"></a>00437       readEnsembles(in);
<a name="l00438"></a>00438 
<a name="l00439"></a>00439       <span class="comment">// Integrator</span>
<a name="l00440"></a>00440       std::string className;
<a name="l00441"></a>00441       <span class="keywordtype">bool</span> isEnd;
<a name="l00442"></a>00442       integratorPtr_ = 
<a name="l00443"></a>00443          integratorFactory().readObject(in, *<span class="keyword">this</span>, className, isEnd);
<a name="l00444"></a>00444       <span class="keywordflow">if</span> (!integratorPtr_) {
<a name="l00445"></a>00445          std::string msg(<span class="stringliteral">&quot;Unknown Integrator subclass name: &quot;</span>);
<a name="l00446"></a>00446          msg += className;
<a name="l00447"></a>00447          <a class="code" href="global_8h.html#ad2512f8bd062d41d66799cf900151487" title="Macro for throwing an Exception, reporting function, file and line number.">UTIL_THROW</a>(<span class="stringliteral">&quot;msg.c_str()&quot;</span>);
<a name="l00448"></a>00448       }
<a name="l00449"></a>00449 
<a name="l00450"></a>00450       readParamComposite(in, random_);
<a name="l00451"></a>00451       readParamComposite(in, *diagnosticManagerPtr_);
<a name="l00452"></a>00452 
<a name="l00453"></a>00453       exchanger_.setPairCutoff(pairPotentialPtr_-&gt;cutoff());
<a name="l00454"></a>00454       exchanger_.allocate();
<a name="l00455"></a>00455 
<a name="l00456"></a>00456       <span class="comment">// Set signals</span>
<a name="l00457"></a>00457       modifySignal().addObserver(*<span class="keyword">this</span>, &amp;<a class="code" href="classDdMd_1_1Simulation.html#a1c3b0b9f5d98d69b986a230280112a9f" title="Mark kinetic energy as unknown.">Simulation::unsetKineticEnergy</a> );
<a name="l00458"></a>00458       modifySignal().addObserver(*<span class="keyword">this</span>, &amp;<a class="code" href="classDdMd_1_1Simulation.html#a942ea5912d3b51e6555386d9bedf9cc0" title="Mark kinetic stress as unknown.">Simulation::unsetKineticStress</a> );
<a name="l00459"></a>00459       modifySignal().addObserver(*<span class="keyword">this</span>, &amp;<a class="code" href="classDdMd_1_1Simulation.html#a955ba405cdfefd575d96f32844a32806" title="Mark all potential energies as unknown.">Simulation::unsetPotentialEnergies</a> );
<a name="l00460"></a>00460       modifySignal().addObserver(*<span class="keyword">this</span>, &amp;<a class="code" href="classDdMd_1_1Simulation.html#a4a1edac5aef1cd1c1b3189e5b1d960e2" title="Mark all virial stress contributions as unknown.">Simulation::unsetVirialStress</a> );
<a name="l00461"></a>00461 
<a name="l00462"></a>00462       velocitySignal().addObserver(*<span class="keyword">this</span>, &amp;<a class="code" href="classDdMd_1_1Simulation.html#a1c3b0b9f5d98d69b986a230280112a9f" title="Mark kinetic energy as unknown.">Simulation::unsetKineticEnergy</a> );
<a name="l00463"></a>00463       velocitySignal().addObserver(*<span class="keyword">this</span>, &amp;<a class="code" href="classDdMd_1_1Simulation.html#a942ea5912d3b51e6555386d9bedf9cc0" title="Mark kinetic stress as unknown.">Simulation::unsetKineticStress</a> );
<a name="l00464"></a>00464 
<a name="l00465"></a>00465       positionSignal().addObserver(*<span class="keyword">this</span>, &amp;<a class="code" href="classDdMd_1_1Simulation.html#a955ba405cdfefd575d96f32844a32806" title="Mark all potential energies as unknown.">Simulation::unsetPotentialEnergies</a> );
<a name="l00466"></a>00466       positionSignal().addObserver(*<span class="keyword">this</span>, &amp;<a class="code" href="classDdMd_1_1Simulation.html#a4a1edac5aef1cd1c1b3189e5b1d960e2" title="Mark all virial stress contributions as unknown.">Simulation::unsetVirialStress</a> );
<a name="l00467"></a>00467 
<a name="l00468"></a>00468       readEnd(in);
<a name="l00469"></a>00469    }
<a name="l00470"></a>00470 
<a name="l00474"></a>00474    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#aeb091178ff7457e841eb208be068ed64" title="Read the FileMaster.">Simulation::readFileMaster</a>(std::istream &amp;in)
<a name="l00475"></a><a class="code" href="classDdMd_1_1Simulation.html#aeb091178ff7457e841eb208be068ed64">00475</a>    {
<a name="l00476"></a>00476       readParamComposite(in, *fileMasterPtr_);
<a name="l00477"></a>00477    }
<a name="l00478"></a>00478 
<a name="l00482"></a>00482    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#ac28e2495b88ebf03b2833187f5034bb3" title="Read potential styles and maskedPairPolicy.">Simulation::readPotentialStyles</a>(std::istream &amp;in)
<a name="l00483"></a><a class="code" href="classDdMd_1_1Simulation.html#ac28e2495b88ebf03b2833187f5034bb3">00483</a>    {
<a name="l00484"></a>00484 <span class="preprocessor">      #ifndef DDMD_NOPAIR</span>
<a name="l00485"></a>00485 <span class="preprocessor"></span>      read&lt;std::string&gt;(in, <span class="stringliteral">&quot;pairStyle&quot;</span>, pairStyle_);
<a name="l00486"></a>00486 <span class="preprocessor">      #endif</span>
<a name="l00487"></a>00487 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nBondType_) {
<a name="l00488"></a>00488          read&lt;std::string&gt;(in, <span class="stringliteral">&quot;bondStyle&quot;</span>, bondStyle_);
<a name="l00489"></a>00489       }
<a name="l00490"></a>00490 <span class="preprocessor">      #ifdef INTER_ANGLE</span>
<a name="l00491"></a>00491 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nAngleType_) {
<a name="l00492"></a>00492          read&lt;std::string&gt;(in, <span class="stringliteral">&quot;angleStyle&quot;</span>, angleStyle_);
<a name="l00493"></a>00493       }
<a name="l00494"></a>00494 <span class="preprocessor">      #endif</span>
<a name="l00495"></a>00495 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_DIHEDRAL</span>
<a name="l00496"></a>00496 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nDihedralType_) {
<a name="l00497"></a>00497          read&lt;std::string&gt;(in, <span class="stringliteral">&quot;dihedralStyle&quot;</span>, dihedralStyle_);
<a name="l00498"></a>00498       }
<a name="l00499"></a>00499 <span class="preprocessor">      #endif</span>
<a name="l00500"></a>00500 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_EXTERNAL</span>
<a name="l00501"></a>00501 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (hasExternal_) {
<a name="l00502"></a>00502          read&lt;std::string&gt;(in, <span class="stringliteral">&quot;externalStyle&quot;</span>, externalStyle_);
<a name="l00503"></a>00503       }
<a name="l00504"></a>00504 <span class="preprocessor">      #endif</span>
<a name="l00505"></a>00505 <span class="preprocessor"></span>
<a name="l00506"></a>00506       <span class="comment">// Read policy regarding whether to excluded pair interactions</span>
<a name="l00507"></a>00507       <span class="comment">// between covalently bonded pairs.</span>
<a name="l00508"></a>00508       read&lt;MaskPolicy&gt;(in, <span class="stringliteral">&quot;maskedPairPolicy&quot;</span>, maskedPairPolicy_);
<a name="l00509"></a>00509 
<a name="l00510"></a>00510       <span class="comment">// Reverse communication (true) or not (false)?</span>
<a name="l00511"></a>00511       read&lt;bool&gt;(in, <span class="stringliteral">&quot;reverseUpdateFlag&quot;</span>, reverseUpdateFlag_);
<a name="l00512"></a>00512    }
<a name="l00513"></a>00513 
<a name="l00514"></a>00514    <span class="comment">/*</span>
<a name="l00515"></a>00515 <span class="comment">   * Read EnergyEnsemble and BoundaryEnsemble</span>
<a name="l00516"></a>00516 <span class="comment">   */</span>
<a name="l00517"></a>00517    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#ac6951f28a65d6e9e985f3dc511afb025" title="Read energy and boundary ensembles.">Simulation::readEnsembles</a>(std::istream &amp;in)
<a name="l00518"></a><a class="code" href="classDdMd_1_1Simulation.html#ac6951f28a65d6e9e985f3dc511afb025">00518</a>    {
<a name="l00519"></a>00519       readParamComposite(in, *energyEnsemblePtr_);
<a name="l00520"></a>00520       readParamComposite(in, *boundaryEnsemblePtr_);
<a name="l00521"></a>00521    }
<a name="l00522"></a>00522 
<a name="l00523"></a>00523    <span class="comment">/*</span>
<a name="l00524"></a>00524 <span class="comment">   * Read and implement commands in an input script.</span>
<a name="l00525"></a>00525 <span class="comment">   */</span>
<a name="l00526"></a>00526    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#a58f73ad42249ca9d08aea965ec0140a3" title="Read and execute commands from the default command file.">Simulation::readCommands</a>(std::istream &amp;in)
<a name="l00527"></a>00527    {
<a name="l00528"></a>00528       std::string   command;
<a name="l00529"></a>00529       std::string   filename;
<a name="l00530"></a>00530       std::ifstream inputFile;
<a name="l00531"></a>00531       std::ofstream outputFile;
<a name="l00532"></a>00532 
<a name="l00533"></a>00533 <span class="preprocessor">      #ifndef UTIL_MPI</span>
<a name="l00534"></a>00534 <span class="preprocessor"></span>      std::istream&amp;     inBuffer = in;
<a name="l00535"></a>00535 <span class="preprocessor">      #else</span>
<a name="l00536"></a>00536 <span class="preprocessor"></span>      std::stringstream inBuffer;
<a name="l00537"></a>00537       std::string       line;
<a name="l00538"></a>00538 <span class="preprocessor">      #endif</span>
<a name="l00539"></a>00539 <span class="preprocessor"></span>
<a name="l00540"></a>00540       <span class="keywordtype">bool</span> readNext = <span class="keyword">true</span>;
<a name="l00541"></a>00541       <span class="keywordflow">while</span> (readNext) {
<a name="l00542"></a>00542 
<a name="l00543"></a>00543 <span class="preprocessor">         #ifdef UTIL_MPI</span>
<a name="l00544"></a>00544 <span class="preprocessor"></span>         <span class="keywordflow">if</span> (!hasParamCommunicator() || isParamIoProcessor()) {
<a name="l00545"></a>00545             <a class="code" href="namespaceUtil.html#a2b72e5bac25f33d81b15d6d4ee2465a1" title="Get the next non-empty line of input, skipping any empty lines.">getNextLine</a>(in, line);
<a name="l00546"></a>00546             <a class="code" href="classUtil_1_1Log.html#a7b86f7c53e482f8f4a1a8b756c162817" title="Get log ostream by reference.">Log::file</a>() &lt;&lt; line &lt;&lt; std::endl;
<a name="l00547"></a>00547          } 
<a name="l00548"></a>00548          <span class="keywordflow">if</span> (hasParamCommunicator()) {
<a name="l00549"></a>00549             bcast&lt;std::string&gt;(domain_.communicator(), line, 0);
<a name="l00550"></a>00550          }
<a name="l00551"></a>00551          inBuffer.clear();
<a name="l00552"></a>00552          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i=0; i &lt; line.size(); ++i) {
<a name="l00553"></a>00553             inBuffer.put(line[i]);
<a name="l00554"></a>00554          }
<a name="l00555"></a>00555 <span class="preprocessor">         #endif</span>
<a name="l00556"></a>00556 <span class="preprocessor"></span>
<a name="l00557"></a>00557          inBuffer &gt;&gt; command;
<a name="l00558"></a>00558          <span class="comment">//Log::file().setf(std::ios_base::left);</span>
<a name="l00559"></a>00559          <span class="comment">//Log::file().width(15);</span>
<a name="l00560"></a>00560          <span class="comment">//Log::file() &lt;&lt; command;</span>
<a name="l00561"></a>00561 
<a name="l00562"></a>00562          <span class="keywordflow">if</span> (command == <span class="stringliteral">&quot;READ_CONFIG&quot;</span>) {
<a name="l00563"></a>00563             inBuffer &gt;&gt; filename;
<a name="l00564"></a>00564             readConfig(filename);
<a name="l00565"></a>00565          } <span class="keywordflow">else</span>
<a name="l00566"></a>00566          <span class="keywordflow">if</span> (command == <span class="stringliteral">&quot;THERMALIZE&quot;</span>) {
<a name="l00567"></a>00567             <span class="keywordtype">double</span> temperature;
<a name="l00568"></a>00568             inBuffer &gt;&gt; temperature;
<a name="l00569"></a>00569             setBoltzmannVelocities(temperature);
<a name="l00570"></a>00570             <span class="comment">//removeDriftVelocity();</span>
<a name="l00571"></a>00571          } <span class="keywordflow">else</span>
<a name="l00572"></a>00572          <span class="keywordflow">if</span> (command == <span class="stringliteral">&quot;SIMULATE&quot;</span>) {
<a name="l00573"></a>00573             <span class="keywordtype">int</span> endStep;
<a name="l00574"></a>00574             inBuffer &gt;&gt; endStep;
<a name="l00575"></a>00575             simulate(endStep);
<a name="l00576"></a>00576          } <span class="keywordflow">else</span>
<a name="l00577"></a>00577          <span class="keywordflow">if</span> (command == <span class="stringliteral">&quot;OUTPUT_INTEGRATOR_STATS&quot;</span>) {
<a name="l00578"></a>00578             integratorPtr_-&gt;outputStatistics(<a class="code" href="classUtil_1_1Log.html#a7b86f7c53e482f8f4a1a8b756c162817" title="Get log ostream by reference.">Log::file</a>());
<a name="l00579"></a>00579          } <span class="keywordflow">else</span>
<a name="l00580"></a>00580          <span class="keywordflow">if</span> (command == <span class="stringliteral">&quot;OUTPUT_EXCHANGER_STATS&quot;</span>) {
<a name="l00581"></a>00581             <span class="keywordtype">int</span> nStep = integratorPtr_-&gt;nStep();
<a name="l00582"></a>00582             <span class="keywordtype">double</span> time  = integratorPtr_-&gt;time();
<a name="l00583"></a>00583             exchanger_.outputStatistics(<a class="code" href="classUtil_1_1Log.html#a7b86f7c53e482f8f4a1a8b756c162817" title="Get log ostream by reference.">Log::file</a>(), time, nStep);
<a name="l00584"></a>00584          } <span class="keywordflow">else</span>
<a name="l00585"></a>00585          <span class="keywordflow">if</span> (command == <span class="stringliteral">&quot;OUTPUT_MEMORY_STATS&quot;</span>) {
<a name="l00586"></a>00586             atomStorage().computeStatistics(domain_.communicator());
<a name="l00587"></a>00587             bondStorage().computeStatistics(domain_.communicator());
<a name="l00588"></a>00588             buffer().computeStatistics(domain_.communicator());
<a name="l00589"></a>00589             pairPotential().pairList().computeStatistics(domain_.communicator());
<a name="l00590"></a>00590             <span class="keywordflow">if</span> (domain_.isMaster()) {
<a name="l00591"></a>00591                atomStorage().outputStatistics(<a class="code" href="classUtil_1_1Log.html#a7b86f7c53e482f8f4a1a8b756c162817" title="Get log ostream by reference.">Log::file</a>());
<a name="l00592"></a>00592                bondStorage().outputStatistics(<a class="code" href="classUtil_1_1Log.html#a7b86f7c53e482f8f4a1a8b756c162817" title="Get log ostream by reference.">Log::file</a>());
<a name="l00593"></a>00593                buffer().outputStatistics(<a class="code" href="classUtil_1_1Log.html#a7b86f7c53e482f8f4a1a8b756c162817" title="Get log ostream by reference.">Log::file</a>());
<a name="l00594"></a>00594                pairPotential().pairList().outputStatistics(<a class="code" href="classUtil_1_1Log.html#a7b86f7c53e482f8f4a1a8b756c162817" title="Get log ostream by reference.">Log::file</a>());
<a name="l00595"></a>00595                <a class="code" href="classUtil_1_1Log.html#a7b86f7c53e482f8f4a1a8b756c162817" title="Get log ostream by reference.">Log::file</a>() &lt;&lt; std::endl;
<a name="l00596"></a>00596             }
<a name="l00597"></a>00597          } <span class="keywordflow">else</span>
<a name="l00598"></a>00598          <span class="keywordflow">if</span> (command == <span class="stringliteral">&quot;WRITE_CONFIG&quot;</span>) {
<a name="l00599"></a>00599             inBuffer &gt;&gt; filename;
<a name="l00600"></a>00600             writeConfig(filename);
<a name="l00601"></a>00601          } <span class="keywordflow">else</span>
<a name="l00602"></a>00602          <span class="keywordflow">if</span> (command == <span class="stringliteral">&quot;WRITE_PARAM&quot;</span>) {
<a name="l00603"></a>00603             inBuffer &gt;&gt; filename;
<a name="l00604"></a>00604             fileMaster().openOutputFile(filename, outputFile);
<a name="l00605"></a>00605             writeParam(outputFile);
<a name="l00606"></a>00606             outputFile.close();
<a name="l00607"></a>00607          } <span class="keywordflow">else</span>
<a name="l00608"></a>00608          <span class="keywordflow">if</span> (command == <span class="stringliteral">&quot;SET_CONFIG_IO&quot;</span>) {
<a name="l00609"></a>00609             std::string classname;
<a name="l00610"></a>00610             inBuffer &gt;&gt; classname;
<a name="l00611"></a>00611             setConfigIo(classname);
<a name="l00612"></a>00612          } <span class="keywordflow">else</span>
<a name="l00613"></a>00613          <span class="keywordflow">if</span> (command == <span class="stringliteral">&quot;FINISH&quot;</span>) {
<a name="l00614"></a>00614             readNext = <span class="keyword">false</span>;
<a name="l00615"></a>00615          } <span class="keywordflow">else</span> {
<a name="l00616"></a>00616             <a class="code" href="classUtil_1_1Log.html#a7b86f7c53e482f8f4a1a8b756c162817" title="Get log ostream by reference.">Log::file</a>() &lt;&lt; <span class="stringliteral">&quot;Error: Unknown command  &quot;</span> &lt;&lt; std::endl;
<a name="l00617"></a>00617             readNext = <span class="keyword">false</span>;
<a name="l00618"></a>00618          }
<a name="l00619"></a>00619 
<a name="l00620"></a>00620       }
<a name="l00621"></a>00621    }
<a name="l00622"></a>00622 
<a name="l00623"></a>00623    <span class="comment">/*</span>
<a name="l00624"></a>00624 <span class="comment">   * Read and implement commands from the default command file.</span>
<a name="l00625"></a>00625 <span class="comment">   */</span>
<a name="l00626"></a>00626    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#a58f73ad42249ca9d08aea965ec0140a3" title="Read and execute commands from the default command file.">Simulation::readCommands</a>()
<a name="l00627"></a><a class="code" href="classDdMd_1_1Simulation.html#a58f73ad42249ca9d08aea965ec0140a3">00627</a>    {  readCommands(fileMaster().commandFile()); }
<a name="l00628"></a>00628 
<a name="l00629"></a>00629    <span class="comment">/*</span>
<a name="l00630"></a>00630 <span class="comment">   * Set flag to specify if reverse communication is enabled.</span>
<a name="l00631"></a>00631 <span class="comment">   */</span>
<a name="l00632"></a>00632    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#acc8bf12d5a2bd965405e2673458c8655" title="Set flag to identify if reverse communication is enabled.">Simulation::setReverseUpdateFlag</a>(<span class="keywordtype">bool</span> reverseUpdateFlag)
<a name="l00633"></a><a class="code" href="classDdMd_1_1Simulation.html#acc8bf12d5a2bd965405e2673458c8655">00633</a>    {  
<a name="l00634"></a>00634       reverseUpdateFlag_ = reverseUpdateFlag; 
<a name="l00635"></a>00635       <span class="keywordflow">if</span> (pairPotentialPtr_) {
<a name="l00636"></a>00636          pairPotentialPtr_-&gt;setReverseUpdateFlag(reverseUpdateFlag);
<a name="l00637"></a>00637       }
<a name="l00638"></a>00638    }
<a name="l00639"></a>00639 
<a name="l00640"></a>00640    <span class="comment">/*</span>
<a name="l00641"></a>00641 <span class="comment">   * Choose velocities from a Boltzmann distribution.</span>
<a name="l00642"></a>00642 <span class="comment">   */</span>
<a name="l00643"></a>00643    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#ae04aeb46428f975caea76e1c2df873db" title="Set random velocities chosen from Boltzmann distribution.">Simulation::setBoltzmannVelocities</a>(<span class="keywordtype">double</span> temperature)
<a name="l00644"></a><a class="code" href="classDdMd_1_1Simulation.html#ae04aeb46428f975caea76e1c2df873db">00644</a>    {
<a name="l00645"></a>00645       <span class="keywordtype">double</span> scale = sqrt(temperature);
<a name="l00646"></a>00646       <a class="code" href="classDdMd_1_1AtomIterator.html" title="Iterator for all atoms owned by an AtomStorage.">AtomIterator</a> atomIter;
<a name="l00647"></a>00647       <span class="keywordtype">int</span> i;
<a name="l00648"></a>00648 
<a name="l00649"></a>00649       atomStorage_.begin(atomIter); 
<a name="l00650"></a>00650       <span class="keywordflow">for</span>( ; atomIter.<a class="code" href="classUtil_1_1PArrayIterator.html#a9a108a1b20ef4c09353b96ad5b29cc4d" title="Is the current pointer not at the end of the PArray?">notEnd</a>(); ++atomIter){
<a name="l00651"></a>00651          <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__Space__Module.html#ga2772f5ec799816685d37798d8d358ef7" title="Dimensionality of space.">Dimension</a>; ++i) {
<a name="l00652"></a>00652             atomIter-&gt;velocity()[i] = scale*random_.gaussian();
<a name="l00653"></a>00653          }
<a name="l00654"></a>00654       }
<a name="l00655"></a>00655       velocitySignal().notify();
<a name="l00656"></a>00656    }
<a name="l00657"></a>00657 
<a name="l00658"></a>00658    <span class="comment">/*</span>
<a name="l00659"></a>00659 <span class="comment">   * Set forces on all local atoms to zero.</span>
<a name="l00660"></a>00660 <span class="comment">   * If reverseUpdateFlag(), also zero ghost atom forces.</span>
<a name="l00661"></a>00661 <span class="comment">   */</span>
<a name="l00662"></a>00662    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#ad29214d7595ff51e6fc0172e681f606a" title="Set forces for all local atoms to zero.">Simulation::zeroForces</a>()
<a name="l00663"></a><a class="code" href="classDdMd_1_1Simulation.html#ad29214d7595ff51e6fc0172e681f606a">00663</a>    {
<a name="l00664"></a>00664       <span class="comment">// Zero local atoms</span>
<a name="l00665"></a>00665       <a class="code" href="classDdMd_1_1AtomIterator.html" title="Iterator for all atoms owned by an AtomStorage.">AtomIterator</a> atomIter;
<a name="l00666"></a>00666       atomStorage_.begin(atomIter); 
<a name="l00667"></a>00667       <span class="keywordflow">for</span>( ; atomIter.<a class="code" href="classUtil_1_1PArrayIterator.html#a9a108a1b20ef4c09353b96ad5b29cc4d" title="Is the current pointer not at the end of the PArray?">notEnd</a>(); ++atomIter){
<a name="l00668"></a>00668          atomIter-&gt;force().zero();
<a name="l00669"></a>00669       }
<a name="l00670"></a>00670 
<a name="l00671"></a>00671       <span class="comment">// If using reverse communication, zero ghost atoms</span>
<a name="l00672"></a>00672       <span class="keywordflow">if</span> (reverseUpdateFlag_) {
<a name="l00673"></a>00673          <a class="code" href="classDdMd_1_1GhostIterator.html" title="Iterator for all ghost atoms owned by an AtomStorage.">GhostIterator</a> ghostIter;
<a name="l00674"></a>00674          atomStorage_.begin(ghostIter); 
<a name="l00675"></a>00675          <span class="keywordflow">for</span>( ; ghostIter.<a class="code" href="classUtil_1_1PArrayIterator.html#a9a108a1b20ef4c09353b96ad5b29cc4d" title="Is the current pointer not at the end of the PArray?">notEnd</a>(); ++ghostIter){
<a name="l00676"></a>00676             ghostIter-&gt;force().zero();
<a name="l00677"></a>00677          }
<a name="l00678"></a>00678       }
<a name="l00679"></a>00679    }
<a name="l00680"></a>00680 
<a name="l00681"></a>00681    <span class="comment">/*</span>
<a name="l00682"></a>00682 <span class="comment">   * Compute forces for all atoms.</span>
<a name="l00683"></a>00683 <span class="comment">   */</span>
<a name="l00684"></a>00684    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#a2983b5e88ce2bbf7b0f247921037f26f" title="Compute forces for all local atoms.">Simulation::computeForces</a>()
<a name="l00685"></a><a class="code" href="classDdMd_1_1Simulation.html#a2983b5e88ce2bbf7b0f247921037f26f">00685</a>    {
<a name="l00686"></a>00686       zeroForces();
<a name="l00687"></a>00687       pairPotential().computeForces();
<a name="l00688"></a>00688       bondPotential().computeForces();
<a name="l00689"></a>00689 <span class="preprocessor">      #ifdef INTER_ANGLE</span>
<a name="l00690"></a>00690 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nAngleType_) {
<a name="l00691"></a>00691          anglePotential().computeForces();
<a name="l00692"></a>00692       }
<a name="l00693"></a>00693 <span class="preprocessor">      #endif</span>
<a name="l00694"></a>00694 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_DIHEDRAL</span>
<a name="l00695"></a>00695 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nDihedralType_) {
<a name="l00696"></a>00696          dihedralPotential().computeForces();
<a name="l00697"></a>00697       }
<a name="l00698"></a>00698 <span class="preprocessor">      #endif</span>
<a name="l00699"></a>00699 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_EXTERNAL</span>
<a name="l00700"></a>00700 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (hasExternal_) {
<a name="l00701"></a>00701          externalPotential().computeForces();
<a name="l00702"></a>00702       }
<a name="l00703"></a>00703 <span class="preprocessor">      #endif</span>
<a name="l00704"></a>00704 <span class="preprocessor"></span>
<a name="l00705"></a>00705       <span class="comment">// Reverse communication (if any)</span>
<a name="l00706"></a>00706       <span class="keywordflow">if</span> (reverseUpdateFlag_) {
<a name="l00707"></a>00707          exchanger_.reverseUpdate();
<a name="l00708"></a>00708       }
<a name="l00709"></a>00709 
<a name="l00710"></a>00710    }
<a name="l00711"></a>00711 
<a name="l00712"></a>00712    <span class="comment">/*</span>
<a name="l00713"></a>00713 <span class="comment">   * Compute forces for all atoms and virial stress contributions.</span>
<a name="l00714"></a>00714 <span class="comment">   */</span>
<a name="l00715"></a>00715    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#a109e22d3de64b69eec4c57ca88adf2db" title="Compute forces for all local atoms and virial stress.">Simulation::computeForcesAndVirial</a>()
<a name="l00716"></a><a class="code" href="classDdMd_1_1Simulation.html#a109e22d3de64b69eec4c57ca88adf2db">00716</a>    {
<a name="l00717"></a>00717       zeroForces();
<a name="l00718"></a>00718       pairPotential().computeForcesAndStress(domain_.communicator());
<a name="l00719"></a>00719       bondPotential().computeForcesAndStress(domain_.communicator());
<a name="l00720"></a>00720 <span class="preprocessor">      #ifdef INTER_ANGLE</span>
<a name="l00721"></a>00721 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nAngleType_) {
<a name="l00722"></a>00722          anglePotential().computeForcesAndStress(domain_.communicator());
<a name="l00723"></a>00723       }
<a name="l00724"></a>00724 <span class="preprocessor">      #endif</span>
<a name="l00725"></a>00725 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_DIHEDRAL</span>
<a name="l00726"></a>00726 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nDihedralType_) {
<a name="l00727"></a>00727          dihedralPotential().computeForcesAndStress(domain_.communicator());
<a name="l00728"></a>00728       }
<a name="l00729"></a>00729 <span class="preprocessor">      #endif</span>
<a name="l00730"></a>00730 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_EXTERNAL</span>
<a name="l00731"></a>00731 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (hasExternal_) {
<a name="l00732"></a>00732          externalPotential().computeForces();
<a name="l00733"></a>00733       }
<a name="l00734"></a>00734 <span class="preprocessor">      #endif</span>
<a name="l00735"></a>00735 <span class="preprocessor"></span>
<a name="l00736"></a>00736       <span class="comment">// Reverse communication (if any)</span>
<a name="l00737"></a>00737       <span class="keywordflow">if</span> (reverseUpdateFlag_) {
<a name="l00738"></a>00738          exchanger_.reverseUpdate();
<a name="l00739"></a>00739       }
<a name="l00740"></a>00740    }
<a name="l00741"></a>00741 
<a name="l00742"></a>00742    <span class="comment">/*</span>
<a name="l00743"></a>00743 <span class="comment">   * Integrate.</span>
<a name="l00744"></a>00744 <span class="comment">   */</span>
<a name="l00745"></a>00745    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#abbd769765ed0e640232b475a9cc3baab" title="Integrate equations of motion.">Simulation::simulate</a>(<span class="keywordtype">int</span> nStep)
<a name="l00746"></a><a class="code" href="classDdMd_1_1Simulation.html#abbd769765ed0e640232b475a9cc3baab">00746</a>    {
<a name="l00747"></a>00747       <span class="comment">// Preconditions</span>
<a name="l00748"></a>00748       assert(integratorPtr_);
<a name="l00749"></a>00749 
<a name="l00750"></a>00750       <span class="keywordflow">if</span> (domain_.isMaster()) {
<a name="l00751"></a>00751          <a class="code" href="classUtil_1_1Log.html#a7b86f7c53e482f8f4a1a8b756c162817" title="Get log ostream by reference.">Log::file</a>() &lt;&lt; std::endl;
<a name="l00752"></a>00752       }
<a name="l00753"></a>00753 
<a name="l00754"></a>00754       integratorPtr_-&gt;setup();
<a name="l00755"></a>00755       integratorPtr_-&gt;run(nStep);
<a name="l00756"></a>00756    }
<a name="l00757"></a>00757 
<a name="l00758"></a>00758    <span class="comment">// Kinetic Energy methods ------------------------------------------------------</span>
<a name="l00759"></a>00759 
<a name="l00760"></a>00760    <span class="comment">/*</span>
<a name="l00761"></a>00761 <span class="comment">   * Calculate total kinetic energy (call on all processors).</span>
<a name="l00762"></a>00762 <span class="comment">   */</span>
<a name="l00763"></a>00763    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#a8589034d49d77db29774fe9bc67287cb" title="Compute total kinetic energy.">Simulation::computeKineticEnergy</a>()
<a name="l00764"></a><a class="code" href="classDdMd_1_1Simulation.html#a8589034d49d77db29774fe9bc67287cb">00764</a>    {
<a name="l00765"></a>00765       <span class="comment">// Do nothing if kinetic energy is already set.</span>
<a name="l00766"></a>00766       <span class="keywordflow">if</span> (kineticEnergy_.isSet()) <span class="keywordflow">return</span>;
<a name="l00767"></a>00767 
<a name="l00768"></a>00768       <span class="keywordtype">double</span> localEnergy = 0.0;
<a name="l00769"></a>00769       <span class="keywordtype">double</span> mass;
<a name="l00770"></a>00770       <span class="keywordtype">int</span> typeId;
<a name="l00771"></a>00771 
<a name="l00772"></a>00772       <span class="comment">// Add kinetic energies of local atoms on this processor</span>
<a name="l00773"></a>00773       <a class="code" href="classDdMd_1_1AtomIterator.html" title="Iterator for all atoms owned by an AtomStorage.">AtomIterator</a> atomIter;
<a name="l00774"></a>00774       atomStorage_.begin(atomIter); 
<a name="l00775"></a>00775       <span class="keywordflow">for</span>( ; atomIter.<a class="code" href="classUtil_1_1PArrayIterator.html#a9a108a1b20ef4c09353b96ad5b29cc4d" title="Is the current pointer not at the end of the PArray?">notEnd</a>(); ++atomIter){
<a name="l00776"></a>00776          typeId = atomIter-&gt;typeId();
<a name="l00777"></a>00777          mass   = atomTypes_[typeId].mass();
<a name="l00778"></a>00778          localEnergy += mass*(atomIter-&gt;velocity().square());
<a name="l00779"></a>00779       }
<a name="l00780"></a>00780       localEnergy = 0.5*localEnergy;
<a name="l00781"></a>00781 
<a name="l00782"></a>00782 <span class="preprocessor">      #ifdef UTIL_MPI</span>
<a name="l00783"></a>00783 <span class="preprocessor"></span>      <span class="comment">// Sum values from all processors.</span>
<a name="l00784"></a>00784       <span class="keywordtype">double</span> totalEnergy = 0.0;
<a name="l00785"></a>00785       domain_.communicator().Reduce(&amp;localEnergy, &amp;totalEnergy, 1, 
<a name="l00786"></a>00786                                     MPI::DOUBLE, MPI::SUM, 0);
<a name="l00787"></a>00787       <span class="keywordflow">if</span> (domain_.communicator().Get_rank() != 0) {
<a name="l00788"></a>00788          totalEnergy = 0.0;
<a name="l00789"></a>00789       }
<a name="l00790"></a>00790       kineticEnergy_.set(totalEnergy);
<a name="l00791"></a>00791 <span class="preprocessor">      #else</span>
<a name="l00792"></a>00792 <span class="preprocessor"></span>      kineticEnergy_.set(localEnergy);
<a name="l00793"></a>00793 <span class="preprocessor">      #endif</span>
<a name="l00794"></a>00794 <span class="preprocessor"></span>   }
<a name="l00795"></a>00795 
<a name="l00796"></a>00796    <span class="comment">/*</span>
<a name="l00797"></a>00797 <span class="comment">   * Return total kinetic energy (on master processor).</span>
<a name="l00798"></a>00798 <span class="comment">   * </span>
<a name="l00799"></a>00799 <span class="comment">   * Call only on master processor.</span>
<a name="l00800"></a>00800 <span class="comment">   */</span>
<a name="l00801"></a>00801    <span class="keywordtype">double</span> <a class="code" href="classDdMd_1_1Simulation.html#a10c17ef9707e9c64b0295b19089ad6e4" title="Return precomputed total kinetic energy.">Simulation::kineticEnergy</a>()
<a name="l00802"></a><a class="code" href="classDdMd_1_1Simulation.html#a10c17ef9707e9c64b0295b19089ad6e4">00802</a>    {  <span class="keywordflow">return</span> kineticEnergy_.value(); }
<a name="l00803"></a>00803 
<a name="l00804"></a>00804    <span class="comment">/*</span>
<a name="l00805"></a>00805 <span class="comment">   * Mark kinetic energy as unknown.</span>
<a name="l00806"></a>00806 <span class="comment">   */</span>
<a name="l00807"></a>00807    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#a1c3b0b9f5d98d69b986a230280112a9f" title="Mark kinetic energy as unknown.">Simulation::unsetKineticEnergy</a>()
<a name="l00808"></a><a class="code" href="classDdMd_1_1Simulation.html#a1c3b0b9f5d98d69b986a230280112a9f">00808</a>    {  kineticEnergy_.unset(); }
<a name="l00809"></a>00809 
<a name="l00810"></a>00810    <span class="comment">// Kinetic Stress methods ------------------------------------------------------</span>
<a name="l00811"></a>00811    
<a name="l00812"></a>00812    <span class="comment">/*</span>
<a name="l00813"></a>00813 <span class="comment">   * Compute total kinetic stress, store on master proc.</span>
<a name="l00814"></a>00814 <span class="comment">   *</span>
<a name="l00815"></a>00815 <span class="comment">   * Call on all processors. </span>
<a name="l00816"></a>00816 <span class="comment">   */</span>
<a name="l00817"></a>00817    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#a0f7aabdc04a4129057f7c538546a4852" title="Calculate and store kinetic stress.">Simulation::computeKineticStress</a>()
<a name="l00818"></a><a class="code" href="classDdMd_1_1Simulation.html#a0f7aabdc04a4129057f7c538546a4852">00818</a>    {
<a name="l00819"></a>00819 
<a name="l00820"></a>00820       <span class="comment">// Do nothing and return if kinetic stress is already set</span>
<a name="l00821"></a>00821       <span class="keywordflow">if</span> (kineticStress_.isSet()) <span class="keywordflow">return</span>;
<a name="l00822"></a>00822 
<a name="l00823"></a>00823       <a class="code" href="classUtil_1_1Tensor.html" title="A Tensor represents a Cartesian tensor.">Tensor</a> localStress;
<a name="l00824"></a>00824       <span class="keywordtype">double</span>  mass;
<a name="l00825"></a>00825       <a class="code" href="classUtil_1_1Vector.html" title="A Vector is a Cartesian vector.">Vector</a>  velocity;
<a name="l00826"></a>00826       <span class="keywordtype">int</span> typeId, i, j;
<a name="l00827"></a>00827 
<a name="l00828"></a>00828       localStress.<a class="code" href="classUtil_1_1Tensor.html#aac0c50df8b2fddfa0a2264e9b0866441" title="Set all elements of this tensor to zero.">zero</a>();
<a name="l00829"></a>00829 
<a name="l00830"></a>00830       <span class="comment">// For each local atoms on this processor, stress(i, j) += m*v[i]*v[j]</span>
<a name="l00831"></a>00831       <a class="code" href="classDdMd_1_1AtomIterator.html" title="Iterator for all atoms owned by an AtomStorage.">AtomIterator</a> atomIter;
<a name="l00832"></a>00832       atomStorage_.begin(atomIter); 
<a name="l00833"></a>00833       <span class="keywordflow">for</span>( ; atomIter.<a class="code" href="classUtil_1_1PArrayIterator.html#a9a108a1b20ef4c09353b96ad5b29cc4d" title="Is the current pointer not at the end of the PArray?">notEnd</a>(); ++atomIter){
<a name="l00834"></a>00834          typeId = atomIter-&gt;typeId();
<a name="l00835"></a>00835          velocity = atomIter-&gt;velocity();
<a name="l00836"></a>00836          mass = atomTypes_[typeId].mass();
<a name="l00837"></a>00837          <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__Space__Module.html#ga2772f5ec799816685d37798d8d358ef7" title="Dimensionality of space.">Dimension</a>; ++i) {
<a name="l00838"></a>00838             <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="group__Space__Module.html#ga2772f5ec799816685d37798d8d358ef7" title="Dimensionality of space.">Dimension</a>; ++j) {
<a name="l00839"></a>00839                localStress(i, j) += mass*velocity[i]*velocity[j];
<a name="l00840"></a>00840             }
<a name="l00841"></a>00841          }
<a name="l00842"></a>00842       }
<a name="l00843"></a>00843 
<a name="l00844"></a>00844       <span class="comment">// Divide dyad sum by system volume</span>
<a name="l00845"></a>00845       localStress /= boundary().volume();
<a name="l00846"></a>00846 
<a name="l00847"></a>00847 <span class="preprocessor">      #ifdef UTIL_MPI</span>
<a name="l00848"></a>00848 <span class="preprocessor"></span>      <span class="comment">// Sum values from all processors</span>
<a name="l00849"></a>00849       <a class="code" href="classUtil_1_1Tensor.html" title="A Tensor represents a Cartesian tensor.">Tensor</a> totalStress;
<a name="l00850"></a>00850       domain_.communicator().Reduce(&amp;localStress(0, 0), &amp;totalStress(0, 0), 
<a name="l00851"></a>00851                                     <a class="code" href="group__Space__Module.html#ga2772f5ec799816685d37798d8d358ef7" title="Dimensionality of space.">Dimension</a>*<a class="code" href="group__Space__Module.html#ga2772f5ec799816685d37798d8d358ef7" title="Dimensionality of space.">Dimension</a>, MPI::DOUBLE, MPI::SUM, 0);
<a name="l00852"></a>00852       <span class="keywordflow">if</span> (domain_.communicator().Get_rank() != 0) {
<a name="l00853"></a>00853          totalStress.<a class="code" href="classUtil_1_1Tensor.html#aac0c50df8b2fddfa0a2264e9b0866441" title="Set all elements of this tensor to zero.">zero</a>();
<a name="l00854"></a>00854       }
<a name="l00855"></a>00855       kineticStress_.set(totalStress);
<a name="l00856"></a>00856 <span class="preprocessor">      #else</span>
<a name="l00857"></a>00857 <span class="preprocessor"></span>      kineticStress_.set(localStress);
<a name="l00858"></a>00858 <span class="preprocessor">      #endif</span>
<a name="l00859"></a>00859 <span class="preprocessor"></span>   }
<a name="l00860"></a>00860 
<a name="l00861"></a>00861    <span class="comment">/*</span>
<a name="l00862"></a>00862 <span class="comment">   * Return total kinetic stress (on master processor).</span>
<a name="l00863"></a>00863 <span class="comment">   */</span>
<a name="l00864"></a>00864    <a class="code" href="classUtil_1_1Tensor.html" title="A Tensor represents a Cartesian tensor.">Tensor</a> <a class="code" href="classDdMd_1_1Simulation.html#ac2e933f62ec4aad35d17a52cccf5a551" title="Return total kinetic stress.">Simulation::kineticStress</a>()<span class="keyword"> const</span>
<a name="l00865"></a><a class="code" href="classDdMd_1_1Simulation.html#ac2e933f62ec4aad35d17a52cccf5a551">00865</a> <span class="keyword">   </span>{  <span class="keywordflow">return</span> kineticStress_.value(); }
<a name="l00866"></a>00866 
<a name="l00867"></a>00867    <span class="comment">/*</span>
<a name="l00868"></a>00868 <span class="comment">   * Return total kinetic pressure (on master processor).</span>
<a name="l00869"></a>00869 <span class="comment">   */</span>
<a name="l00870"></a>00870    <span class="keywordtype">double</span> <a class="code" href="classDdMd_1_1Simulation.html#aaa7d076b9b314accc75cf6606bf4b09a" title="Return total kinetic pressure.">Simulation::kineticPressure</a>()<span class="keyword"> const</span>
<a name="l00871"></a><a class="code" href="classDdMd_1_1Simulation.html#aaa7d076b9b314accc75cf6606bf4b09a">00871</a> <span class="keyword">   </span>{
<a name="l00872"></a>00872       <span class="keywordtype">double</span> pressure = 0.0;
<a name="l00873"></a>00873       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="group__Space__Module.html#ga2772f5ec799816685d37798d8d358ef7" title="Dimensionality of space.">Dimension</a>; ++i) {
<a name="l00874"></a>00874          pressure += kineticStress_.value()(i, i);
<a name="l00875"></a>00875       }
<a name="l00876"></a>00876       pressure /= 3.0;
<a name="l00877"></a>00877       <span class="keywordflow">return</span> pressure;
<a name="l00878"></a>00878    }
<a name="l00879"></a>00879 
<a name="l00880"></a>00880    <span class="comment">/*</span>
<a name="l00881"></a>00881 <span class="comment">   * Mark kinetic stress as unknown.</span>
<a name="l00882"></a>00882 <span class="comment">   */</span>
<a name="l00883"></a>00883    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#a942ea5912d3b51e6555386d9bedf9cc0" title="Mark kinetic stress as unknown.">Simulation::unsetKineticStress</a>()
<a name="l00884"></a><a class="code" href="classDdMd_1_1Simulation.html#a942ea5912d3b51e6555386d9bedf9cc0">00884</a>    {  kineticStress_.unset(); }
<a name="l00885"></a>00885 
<a name="l00886"></a>00886    <span class="comment">// Potential Energy Methods ------------------------------------------------------</span>
<a name="l00887"></a>00887    
<a name="l00888"></a>00888 <span class="preprocessor">   #ifdef UTIL_MPI</span>
<a name="l00889"></a>00889 <span class="preprocessor"></span>
<a name="l00890"></a>00890    <span class="comment">/*</span>
<a name="l00891"></a>00891 <span class="comment">   * Compute all potential energy contributions.</span>
<a name="l00892"></a>00892 <span class="comment">   */</span>
<a name="l00893"></a>00893    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#abd33378ad2f63ff05d667915be115926" title="Calculate and store total potential energy on all processors.">Simulation::computePotentialEnergies</a>() 
<a name="l00894"></a><a class="code" href="classDdMd_1_1Simulation.html#abd33378ad2f63ff05d667915be115926">00894</a>    {
<a name="l00895"></a>00895       pairPotential().computeEnergy(domain_.communicator());
<a name="l00896"></a>00896       bondPotential().computeEnergy(domain_.communicator());
<a name="l00897"></a>00897 <span class="preprocessor">      #ifdef INTER_ANGLE</span>
<a name="l00898"></a>00898 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nAngleType_) {
<a name="l00899"></a>00899          anglePotential().computeEnergy(domain_.communicator());
<a name="l00900"></a>00900       }
<a name="l00901"></a>00901 <span class="preprocessor">      #endif</span>
<a name="l00902"></a>00902 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_DIHEDRAL</span>
<a name="l00903"></a>00903 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nDihedralType_) {
<a name="l00904"></a>00904          dihedralPotential().computeEnergy(domain_.communicator());
<a name="l00905"></a>00905       }
<a name="l00906"></a>00906 <span class="preprocessor">      #endif</span>
<a name="l00907"></a>00907 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_EXTERNAL</span>
<a name="l00908"></a>00908 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (hasExternal_) {
<a name="l00909"></a>00909          externalPotential().computeEnergy(domain_.communicator());
<a name="l00910"></a>00910       }
<a name="l00911"></a>00911 <span class="preprocessor">      #endif</span>
<a name="l00912"></a>00912 <span class="preprocessor"></span>   }
<a name="l00913"></a>00913 
<a name="l00914"></a>00914 <span class="preprocessor">   #else</span>
<a name="l00915"></a>00915 <span class="preprocessor"></span>
<a name="l00916"></a>00916    <span class="comment">/*</span>
<a name="l00917"></a>00917 <span class="comment">   * Compute all potential energy contributions.</span>
<a name="l00918"></a>00918 <span class="comment">   */</span>
<a name="l00919"></a>00919    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#abd33378ad2f63ff05d667915be115926" title="Calculate and store total potential energy on all processors.">Simulation::computePotentialEnergies</a>() 
<a name="l00920"></a>00920    {
<a name="l00921"></a>00921       pairPotential().computeEnergy();
<a name="l00922"></a>00922       bondPotential().computeEnergy();
<a name="l00923"></a>00923 <span class="preprocessor">      #ifdef INTER_ANGLE</span>
<a name="l00924"></a>00924 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nAngleType_) {
<a name="l00925"></a>00925          anglePotential().computeEnergy();
<a name="l00926"></a>00926       }
<a name="l00927"></a>00927 <span class="preprocessor">      #endif</span>
<a name="l00928"></a>00928 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_DIHEDRAL</span>
<a name="l00929"></a>00929 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nDihedralType_) {
<a name="l00930"></a>00930          dihedralPotential().computeEnergy();
<a name="l00931"></a>00931       }
<a name="l00932"></a>00932 <span class="preprocessor">      #endif</span>
<a name="l00933"></a>00933 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_EXTERNAL</span>
<a name="l00934"></a>00934 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (hasExternal_) {
<a name="l00935"></a>00935          externalPotential().computeEnergy();
<a name="l00936"></a>00936       }
<a name="l00937"></a>00937 <span class="preprocessor">      #endif</span>
<a name="l00938"></a>00938 <span class="preprocessor"></span>   }
<a name="l00939"></a>00939 
<a name="l00940"></a>00940 <span class="preprocessor">   #endif</span>
<a name="l00941"></a>00941 <span class="preprocessor"></span>
<a name="l00942"></a>00942    <span class="comment">/*</span>
<a name="l00943"></a>00943 <span class="comment">   * Methods computePotentialEnergies and computeStress rely on use</span>
<a name="l00944"></a>00944 <span class="comment">   * of lazy (as-needed) evaluation within the compute methods of </span>
<a name="l00945"></a>00945 <span class="comment">   * each of the potential energy classes: Each potential energy or</span>
<a name="l00946"></a>00946 <span class="comment">   * virial contribution is actually computed only if it has been</span>
<a name="l00947"></a>00947 <span class="comment">   * unset since the last evaluation. Lazy evaluation is implemented</span>
<a name="l00948"></a>00948 <span class="comment">   * explicitly in the Simulation class only for the kinetic energy</span>
<a name="l00949"></a>00949 <span class="comment">   * and kinetic stress, which are stored as members of Simulation.</span>
<a name="l00950"></a>00950 <span class="comment">   */</span> 
<a name="l00951"></a>00951 
<a name="l00952"></a>00952    <span class="comment">/*</span>
<a name="l00953"></a>00953 <span class="comment">   * Compute all potential energy contributions.</span>
<a name="l00954"></a>00954 <span class="comment">   */</span>
<a name="l00955"></a>00955    <span class="keywordtype">double</span> <a class="code" href="classDdMd_1_1Simulation.html#af5343ea084c10df1bdec06fdb67e6c83" title="Return precomputed total potential energy.">Simulation::potentialEnergy</a>()<span class="keyword"> const</span>
<a name="l00956"></a><a class="code" href="classDdMd_1_1Simulation.html#af5343ea084c10df1bdec06fdb67e6c83">00956</a> <span class="keyword">   </span>{
<a name="l00957"></a>00957       <span class="keywordtype">double</span> energy = 0.0;
<a name="l00958"></a>00958       energy += pairPotentialPtr_-&gt;energy();
<a name="l00959"></a>00959       energy += bondPotentialPtr_-&gt;energy();
<a name="l00960"></a>00960 <span class="preprocessor">      #ifdef INTER_ANGLE</span>
<a name="l00961"></a>00961 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nAngleType_) {
<a name="l00962"></a>00962          energy += anglePotentialPtr_-&gt;energy();
<a name="l00963"></a>00963       }
<a name="l00964"></a>00964 <span class="preprocessor">      #endif</span>
<a name="l00965"></a>00965 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_DIHEDRAL</span>
<a name="l00966"></a>00966 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nDihedralType_) {
<a name="l00967"></a>00967          energy += dihedralPotentialPtr_-&gt;energy();
<a name="l00968"></a>00968       }
<a name="l00969"></a>00969 <span class="preprocessor">      #endif</span>
<a name="l00970"></a>00970 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_EXTERNAL</span>
<a name="l00971"></a>00971 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (hasExternal_) {
<a name="l00972"></a>00972          energy += externalPotentialPtr_-&gt;energy();
<a name="l00973"></a>00973       }
<a name="l00974"></a>00974 <span class="preprocessor">      #endif</span>
<a name="l00975"></a>00975 <span class="preprocessor"></span>      <span class="keywordflow">return</span> energy;
<a name="l00976"></a>00976 
<a name="l00977"></a>00977       <span class="comment">// Note: Pointers used above because ...Potential()) accessors </span>
<a name="l00978"></a>00978       <span class="comment">// return non-const references, which violate the method const.</span>
<a name="l00979"></a>00979    }
<a name="l00980"></a>00980 
<a name="l00981"></a>00981    <span class="comment">/*</span>
<a name="l00982"></a>00982 <span class="comment">   * Mark all potential energies as unknown.</span>
<a name="l00983"></a>00983 <span class="comment">   */</span>
<a name="l00984"></a>00984    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#a955ba405cdfefd575d96f32844a32806" title="Mark all potential energies as unknown.">Simulation::unsetPotentialEnergies</a>()
<a name="l00985"></a><a class="code" href="classDdMd_1_1Simulation.html#a955ba405cdfefd575d96f32844a32806">00985</a>    {
<a name="l00986"></a>00986       pairPotential().unsetEnergy();
<a name="l00987"></a>00987       bondPotential().unsetEnergy();
<a name="l00988"></a>00988 <span class="preprocessor">      #ifdef INTER_ANGLE</span>
<a name="l00989"></a>00989 <span class="preprocessor"></span>      anglePotential().unsetEnergy();
<a name="l00990"></a>00990 <span class="preprocessor">      #endif</span>
<a name="l00991"></a>00991 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_DIHEDRAL</span>
<a name="l00992"></a>00992 <span class="preprocessor"></span>      dihedralPotential().unsetEnergy();
<a name="l00993"></a>00993 <span class="preprocessor">      #endif</span>
<a name="l00994"></a>00994 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_EXTERNAL</span>
<a name="l00995"></a>00995 <span class="preprocessor"></span>      externalPotential().unsetEnergy();
<a name="l00996"></a>00996 <span class="preprocessor">      #endif</span>
<a name="l00997"></a>00997 <span class="preprocessor"></span>   }
<a name="l00998"></a>00998 
<a name="l00999"></a>00999    <span class="comment">// Virial Stress Methods ------------------------------------------------------</span>
<a name="l01000"></a>01000    
<a name="l01001"></a>01001 <span class="preprocessor">   #ifdef UTIL_MPI</span>
<a name="l01002"></a>01002 <span class="preprocessor"></span>   <span class="comment">/*</span>
<a name="l01003"></a>01003 <span class="comment">   * Compute all virial stress contributions.</span>
<a name="l01004"></a>01004 <span class="comment">   */</span>
<a name="l01005"></a>01005    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#aae0238576c11211daa22185a1a809c30" title="Calculate and store all virial stress contributions.">Simulation::computeVirialStress</a>() 
<a name="l01006"></a><a class="code" href="classDdMd_1_1Simulation.html#aae0238576c11211daa22185a1a809c30">01006</a>    {
<a name="l01007"></a>01007       pairPotential().computeStress(domain_.communicator());
<a name="l01008"></a>01008       bondPotential().computeStress(domain_.communicator());
<a name="l01009"></a>01009 <span class="preprocessor">      #ifdef INTER_ANGLE</span>
<a name="l01010"></a>01010 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nAngleType_) {
<a name="l01011"></a>01011          <span class="comment">//anglePotential().computeStress(domain_.communicator());</span>
<a name="l01012"></a>01012       }
<a name="l01013"></a>01013 <span class="preprocessor">      #endif</span>
<a name="l01014"></a>01014 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_DIHEDRAL</span>
<a name="l01015"></a>01015 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nDihedralType_) {
<a name="l01016"></a>01016          <span class="comment">//dihedralPotential().computeStress(domain_.communicator());</span>
<a name="l01017"></a>01017       }
<a name="l01018"></a>01018 <span class="preprocessor">      #endif</span>
<a name="l01019"></a>01019 <span class="preprocessor"></span>   }
<a name="l01020"></a>01020 
<a name="l01021"></a>01021 <span class="preprocessor">   #else</span>
<a name="l01022"></a>01022 <span class="preprocessor"></span>
<a name="l01023"></a>01023    <span class="comment">/*</span>
<a name="l01024"></a>01024 <span class="comment">   * Return stored value of virial stress (call only on master).</span>
<a name="l01025"></a>01025 <span class="comment">   */</span>
<a name="l01026"></a>01026    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#aae0238576c11211daa22185a1a809c30" title="Calculate and store all virial stress contributions.">Simulation::computeVirialStress</a>() 
<a name="l01027"></a>01027    {
<a name="l01028"></a>01028       pairPotential().computeStress();
<a name="l01029"></a>01029       bondPotential().computeStress();
<a name="l01030"></a>01030 <span class="preprocessor">      #ifdef INTER_ANGLE</span>
<a name="l01031"></a>01031 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nAngleType_) {
<a name="l01032"></a>01032          <span class="comment">//anglePotential().computeStress();</span>
<a name="l01033"></a>01033       }
<a name="l01034"></a>01034 <span class="preprocessor">      #endif</span>
<a name="l01035"></a>01035 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_DIHEDRAL</span>
<a name="l01036"></a>01036 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nDihedralType_) {
<a name="l01037"></a>01037          <span class="comment">//dihedralPotential().computeStress();</span>
<a name="l01038"></a>01038       }
<a name="l01039"></a>01039 <span class="preprocessor">      #endif</span>
<a name="l01040"></a>01040 <span class="preprocessor"></span>   }
<a name="l01041"></a>01041 <span class="preprocessor">   #endif</span>
<a name="l01042"></a>01042 <span class="preprocessor"></span>
<a name="l01043"></a>01043    <span class="comment">/*</span>
<a name="l01044"></a>01044 <span class="comment">   * Compute all potential stress contributions.</span>
<a name="l01045"></a>01045 <span class="comment">   */</span>
<a name="l01046"></a>01046    <a class="code" href="classUtil_1_1Tensor.html" title="A Tensor represents a Cartesian tensor.">Tensor</a> <a class="code" href="classDdMd_1_1Simulation.html#a378a34edda1d0b00c881df2193de14bc" title="Return total virial stress.">Simulation::virialStress</a>()<span class="keyword"> const</span>
<a name="l01047"></a><a class="code" href="classDdMd_1_1Simulation.html#a378a34edda1d0b00c881df2193de14bc">01047</a> <span class="keyword">   </span>{
<a name="l01048"></a>01048       <a class="code" href="classUtil_1_1Tensor.html" title="A Tensor represents a Cartesian tensor.">Tensor</a> stress;
<a name="l01049"></a>01049       stress.<a class="code" href="classUtil_1_1Tensor.html#aac0c50df8b2fddfa0a2264e9b0866441" title="Set all elements of this tensor to zero.">zero</a>();
<a name="l01050"></a>01050       stress += pairPotentialPtr_-&gt;stress();
<a name="l01051"></a>01051       stress += bondPotentialPtr_-&gt;stress();
<a name="l01052"></a>01052 <span class="preprocessor">      #ifdef INTER_ANGLE</span>
<a name="l01053"></a>01053 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nAngleType_) {
<a name="l01054"></a>01054          stress += anglePotentialPtr_-&gt;stress();
<a name="l01055"></a>01055       }
<a name="l01056"></a>01056 <span class="preprocessor">      #endif</span>
<a name="l01057"></a>01057 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_DIHEDRAL</span>
<a name="l01058"></a>01058 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nDihedralType_) {
<a name="l01059"></a>01059          stress += dihedralPotentialPtr_-&gt;stress();
<a name="l01060"></a>01060       }
<a name="l01061"></a>01061 <span class="preprocessor">      #endif</span>
<a name="l01062"></a>01062 <span class="preprocessor"></span>      <span class="keywordflow">return</span> stress;
<a name="l01063"></a>01063    }
<a name="l01064"></a>01064 
<a name="l01065"></a>01065    <span class="comment">/*</span>
<a name="l01066"></a>01066 <span class="comment">   * Return total virial pressure contribution.</span>
<a name="l01067"></a>01067 <span class="comment">   */</span>
<a name="l01068"></a>01068    <span class="keywordtype">double</span> <a class="code" href="classDdMd_1_1Simulation.html#a73754ae7a5c4578e5c0c39c06d19612e" title="Return total virial pressure.">Simulation::virialPressure</a>()<span class="keyword"> const</span>
<a name="l01069"></a><a class="code" href="classDdMd_1_1Simulation.html#a73754ae7a5c4578e5c0c39c06d19612e">01069</a> <span class="keyword">   </span>{
<a name="l01070"></a>01070       <span class="keywordtype">double</span> pressure;
<a name="l01071"></a>01071       pressure = 0;
<a name="l01072"></a>01072       pressure += pairPotentialPtr_-&gt;pressure();
<a name="l01073"></a>01073       pressure += bondPotentialPtr_-&gt;pressure();
<a name="l01074"></a>01074 <span class="preprocessor">      #ifdef INTER_ANGLE</span>
<a name="l01075"></a>01075 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nAngleType_) {
<a name="l01076"></a>01076          pressure += anglePotentialPtr_-&gt;pressure();
<a name="l01077"></a>01077       }
<a name="l01078"></a>01078 <span class="preprocessor">      #endif</span>
<a name="l01079"></a>01079 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_DIHEDRAL</span>
<a name="l01080"></a>01080 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nDihedralType_) {
<a name="l01081"></a>01081          pressure += dihedralPotentialPtr_-&gt;pressure();
<a name="l01082"></a>01082       }
<a name="l01083"></a>01083 <span class="preprocessor">      #endif</span>
<a name="l01084"></a>01084 <span class="preprocessor"></span>      <span class="keywordflow">return</span> pressure;
<a name="l01085"></a>01085    }
<a name="l01086"></a>01086 
<a name="l01087"></a>01087 <span class="preprocessor">   #ifdef UTIL_MPI</span>
<a name="l01088"></a>01088 <span class="preprocessor"></span>
<a name="l01089"></a>01089    <span class="comment">/*</span>
<a name="l01090"></a>01090 <span class="comment">   * Compute all pair energy contributions.</span>
<a name="l01091"></a>01091 <span class="comment">   */</span>
<a name="l01092"></a>01092    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#a3ce8878810f70bc57dde69b71abac64e" title="Calculate and store pair energy (or pair energies, depending on nAtomType) on all processors...">Simulation::computePairEnergies</a>()
<a name="l01093"></a><a class="code" href="classDdMd_1_1Simulation.html#a3ce8878810f70bc57dde69b71abac64e">01093</a>    {
<a name="l01094"></a>01094       pairPotential().computePairEnergies(domain_.communicator());
<a name="l01095"></a>01095    }
<a name="l01096"></a>01096 
<a name="l01097"></a>01097 <span class="preprocessor">   #else</span>
<a name="l01098"></a>01098 <span class="preprocessor"></span>
<a name="l01099"></a>01099    <span class="comment">/*</span>
<a name="l01100"></a>01100 <span class="comment">   * Compute all pair energy contributions.</span>
<a name="l01101"></a>01101 <span class="comment">   */</span>
<a name="l01102"></a>01102    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#a3ce8878810f70bc57dde69b71abac64e" title="Calculate and store pair energy (or pair energies, depending on nAtomType) on all processors...">Simulation::computePairEnergies</a>()
<a name="l01103"></a>01103    {
<a name="l01104"></a>01104       pairPotential().computePairEnergies();
<a name="l01105"></a>01105    }
<a name="l01106"></a>01106 
<a name="l01107"></a>01107 <span class="preprocessor">   #endif</span>
<a name="l01108"></a>01108 <span class="preprocessor"></span>
<a name="l01109"></a>01109    <span class="comment">/*</span>
<a name="l01110"></a>01110 <span class="comment">   * Return pair energies contributions.</span>
<a name="l01111"></a>01111 <span class="comment">   */</span>
<a name="l01112"></a>01112    <a class="code" href="classUtil_1_1DMatrix.html">DMatrix&lt;double&gt;</a> <a class="code" href="classDdMd_1_1Simulation.html#aed1cde8e4f39858169a4ae557cf6a4ba" title="Return precomputed pair energy (or pair energies).">Simulation::pairEnergies</a>()<span class="keyword"> const</span>
<a name="l01113"></a><a class="code" href="classDdMd_1_1Simulation.html#aed1cde8e4f39858169a4ae557cf6a4ba">01113</a> <span class="keyword">   </span>{
<a name="l01114"></a>01114       <a class="code" href="classUtil_1_1DMatrix.html">DMatrix&lt;double&gt;</a> pairEnergies;
<a name="l01115"></a>01115       pairEnergies.<a class="code" href="classUtil_1_1DMatrix.html#a8a6eee18a2a8458ccad0cd58df0d6846" title="Allocate memory for a matrix.">allocate</a>(nAtomType_, nAtomType_);
<a name="l01116"></a>01116       pairEnergies = pairPotentialPtr_-&gt;pairEnergies();
<a name="l01117"></a>01117       <span class="keywordflow">return</span> pairEnergies;
<a name="l01118"></a>01118    }
<a name="l01119"></a>01119 
<a name="l01120"></a>01120 
<a name="l01121"></a>01121    <span class="comment">/*</span>
<a name="l01122"></a>01122 <span class="comment">   * Mark all potential energies as unknown.</span>
<a name="l01123"></a>01123 <span class="comment">   */</span>
<a name="l01124"></a>01124    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#a4a1edac5aef1cd1c1b3189e5b1d960e2" title="Mark all virial stress contributions as unknown.">Simulation::unsetVirialStress</a>()
<a name="l01125"></a><a class="code" href="classDdMd_1_1Simulation.html#a4a1edac5aef1cd1c1b3189e5b1d960e2">01125</a>    {
<a name="l01126"></a>01126       pairPotential().unsetStress();
<a name="l01127"></a>01127       bondPotential().unsetStress();
<a name="l01128"></a>01128 <span class="preprocessor">      #ifdef INTER_ANGLE</span>
<a name="l01129"></a>01129 <span class="preprocessor"></span>      anglePotential().unsetStress();
<a name="l01130"></a>01130 <span class="preprocessor">      #endif</span>
<a name="l01131"></a>01131 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_DIHEDRAL</span>
<a name="l01132"></a>01132 <span class="preprocessor"></span>      dihedralPotential().unsetStress();
<a name="l01133"></a>01133 <span class="preprocessor">      #endif</span>
<a name="l01134"></a>01134 <span class="preprocessor"></span>   }
<a name="l01135"></a>01135 
<a name="l01136"></a>01136    <span class="comment">// Config File Read and Write -------------------------------------</span>
<a name="l01137"></a>01137 
<a name="l01138"></a>01138    <span class="comment">/*</span>
<a name="l01139"></a>01139 <span class="comment">   * Read configuration file on master and distribute atoms.</span>
<a name="l01140"></a>01140 <span class="comment">   */</span>
<a name="l01141"></a>01141    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#ab9b92083e998d136df9df75cb8677667" title="Read configuration file on master and distribute atoms.">Simulation::readConfig</a>(<span class="keyword">const</span> std::string&amp; filename)
<a name="l01142"></a><a class="code" href="classDdMd_1_1Simulation.html#ab9b92083e998d136df9df75cb8677667">01142</a>    {
<a name="l01143"></a>01143       std::ifstream inputFile;
<a name="l01144"></a>01144       <span class="keywordflow">if</span> (domain_.isMaster()) {
<a name="l01145"></a>01145          fileMaster().openInputFile(filename, inputFile);
<a name="l01146"></a>01146       }
<a name="l01147"></a>01147       <span class="keywordflow">if</span> (configIoPtr_ == 0) {
<a name="l01148"></a>01148          configIoPtr_ = <span class="keyword">new</span> <a class="code" href="classDdMd_1_1DdMdConfigIo.html" title="Native / default format for configuration files.">DdMdConfigIo</a>(*<span class="keyword">this</span>);
<a name="l01149"></a>01149          configIoPtr_-&gt;associate(domain_, boundary_,
<a name="l01150"></a>01150                                  atomStorage_, bondStorage_, 
<a name="l01151"></a>01151                                  #ifdef INTER_ANGLE
<a name="l01152"></a>01152                                  angleStorage_,
<a name="l01153"></a>01153                                  #endif
<a name="l01154"></a>01154                                  #ifdef INTER_DIHEDRAL
<a name="l01155"></a>01155                                  dihedralStorage_,
<a name="l01156"></a>01156                                  #endif
<a name="l01157"></a>01157                                  buffer_);
<a name="l01158"></a>01158          configIoPtr_-&gt;initialize();
<a name="l01159"></a>01159       }
<a name="l01160"></a>01160       configIoPtr_-&gt;readConfig(inputFile, maskedPairPolicy_);
<a name="l01161"></a>01161       exchanger_.exchange();
<a name="l01162"></a>01162       <span class="keywordflow">if</span> (domain_.isMaster()) {
<a name="l01163"></a>01163          inputFile.close();
<a name="l01164"></a>01164       }
<a name="l01165"></a>01165    }
<a name="l01166"></a>01166 
<a name="l01167"></a>01167    <span class="comment">/*</span>
<a name="l01168"></a>01168 <span class="comment">   * Write configuration file on master.</span>
<a name="l01169"></a>01169 <span class="comment">   */</span>
<a name="l01170"></a>01170    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#afda8eea88c0e81663b145a47d1d90588" title="Write configuration file.">Simulation::writeConfig</a>(<span class="keyword">const</span> std::string&amp; filename)
<a name="l01171"></a><a class="code" href="classDdMd_1_1Simulation.html#afda8eea88c0e81663b145a47d1d90588">01171</a>    {
<a name="l01172"></a>01172       std::ofstream outputFile;
<a name="l01173"></a>01173       <span class="keywordflow">if</span> (domain_.isMaster()) {
<a name="l01174"></a>01174          fileMaster().openOutputFile(filename, outputFile);
<a name="l01175"></a>01175       }
<a name="l01176"></a>01176       <span class="keywordflow">if</span> (configIoPtr_ == 0) {
<a name="l01177"></a>01177          configIoPtr_ = <span class="keyword">new</span> <a class="code" href="classDdMd_1_1DdMdConfigIo.html" title="Native / default format for configuration files.">DdMdConfigIo</a>(*<span class="keyword">this</span>);
<a name="l01178"></a>01178          configIoPtr_-&gt;associate(domain_, boundary_,
<a name="l01179"></a>01179                                  atomStorage_, bondStorage_, 
<a name="l01180"></a>01180                                  #ifdef INTER_ANGLE
<a name="l01181"></a>01181                                  angleStorage_,
<a name="l01182"></a>01182                                  #endif
<a name="l01183"></a>01183                                  #ifdef INTER_DIHEDRAL
<a name="l01184"></a>01184                                  dihedralStorage_,
<a name="l01185"></a>01185                                  #endif
<a name="l01186"></a>01186                                  buffer_);
<a name="l01187"></a>01187          configIoPtr_-&gt;initialize();
<a name="l01188"></a>01188       }
<a name="l01189"></a>01189       configIoPtr_-&gt;writeConfig(outputFile);
<a name="l01190"></a>01190       <span class="keywordflow">if</span> (domain_.isMaster()) {
<a name="l01191"></a>01191          outputFile.close();
<a name="l01192"></a>01192       }
<a name="l01193"></a>01193    }
<a name="l01194"></a>01194 
<a name="l01195"></a>01195    <span class="comment">// Potential Factories and Styles -------------------------------------</span>
<a name="l01196"></a>01196    
<a name="l01197"></a>01197 <span class="preprocessor">   #ifndef DDMD_NOPAIR</span>
<a name="l01198"></a>01198 <span class="preprocessor"></span>   <span class="comment">/*</span>
<a name="l01199"></a>01199 <span class="comment">   * Return the PairFactory by reference.</span>
<a name="l01200"></a>01200 <span class="comment">   */</span>
<a name="l01201"></a>01201    <a class="code" href="classUtil_1_1Factory.html">Factory&lt;PairPotential&gt;</a>&amp; <a class="code" href="classDdMd_1_1Simulation.html#ab48939227b9e29f5f8cf935ec92868e2" title="Get the Factory&amp;lt;PairPotential&amp;gt; by reference.">Simulation::pairFactory</a>()
<a name="l01202"></a><a class="code" href="classDdMd_1_1Simulation.html#ab48939227b9e29f5f8cf935ec92868e2">01202</a>    {
<a name="l01203"></a>01203       <span class="keywordflow">if</span> (!pairFactoryPtr_) {
<a name="l01204"></a>01204          pairFactoryPtr_ = <span class="keyword">new</span> <a class="code" href="classDdMd_1_1PairFactory.html" title="Factory for PairPotential objects.">PairFactory</a>(*<span class="keyword">this</span>);
<a name="l01205"></a>01205       }
<a name="l01206"></a>01206       assert(pairFactoryPtr_);
<a name="l01207"></a>01207       <span class="keywordflow">return</span> *pairFactoryPtr_;
<a name="l01208"></a>01208    }
<a name="l01209"></a>01209 
<a name="l01210"></a>01210    <span class="comment">/*</span>
<a name="l01211"></a>01211 <span class="comment">   * Get the pair style string.</span>
<a name="l01212"></a>01212 <span class="comment">   */</span>
<a name="l01213"></a>01213    std::string <a class="code" href="classDdMd_1_1Simulation.html#a3f59d4cda8e4dd1c3f5a4a4ca902cf0a" title="Return nonbonded pair style string.">Simulation::pairStyle</a>()<span class="keyword"> const</span>
<a name="l01214"></a><a class="code" href="classDdMd_1_1Simulation.html#a3f59d4cda8e4dd1c3f5a4a4ca902cf0a">01214</a> <span class="keyword">   </span>{  <span class="keywordflow">return</span> pairStyle_;  }
<a name="l01215"></a>01215 <span class="preprocessor">   #endif</span>
<a name="l01216"></a>01216 <span class="preprocessor"></span>
<a name="l01217"></a>01217    <span class="comment">/*</span>
<a name="l01218"></a>01218 <span class="comment">   * Return the BondFactory by reference.</span>
<a name="l01219"></a>01219 <span class="comment">   */</span>
<a name="l01220"></a>01220    <a class="code" href="classUtil_1_1Factory.html">Factory&lt;BondPotential&gt;</a>&amp; <a class="code" href="classDdMd_1_1Simulation.html#a4127ff1f0bd3458414d496e0c76df4e4" title="Get the associated Factory&amp;lt;BondPotential&amp;gt; by reference.">Simulation::bondFactory</a>()
<a name="l01221"></a><a class="code" href="classDdMd_1_1Simulation.html#a4127ff1f0bd3458414d496e0c76df4e4">01221</a>    {
<a name="l01222"></a>01222       <span class="keywordflow">if</span> (!bondFactoryPtr_) {
<a name="l01223"></a>01223          bondFactoryPtr_ = <span class="keyword">new</span> <a class="code" href="classDdMd_1_1BondFactory.html" title="Factory for BondPotential objects.">BondFactory</a>(*<span class="keyword">this</span>);
<a name="l01224"></a>01224       }
<a name="l01225"></a>01225       assert(bondFactoryPtr_);
<a name="l01226"></a>01226       <span class="keywordflow">return</span> *bondFactoryPtr_;
<a name="l01227"></a>01227    }
<a name="l01228"></a>01228 
<a name="l01229"></a>01229    <span class="comment">/*</span>
<a name="l01230"></a>01230 <span class="comment">   * Get the bond style string.</span>
<a name="l01231"></a>01231 <span class="comment">   */</span>
<a name="l01232"></a>01232    std::string <a class="code" href="classDdMd_1_1Simulation.html#a434fa4a57478f1941d924446a41627b3" title="Return covalent bond style string.">Simulation::bondStyle</a>()<span class="keyword"> const</span>
<a name="l01233"></a><a class="code" href="classDdMd_1_1Simulation.html#a434fa4a57478f1941d924446a41627b3">01233</a> <span class="keyword">   </span>{  <span class="keywordflow">return</span> bondStyle_;  }
<a name="l01234"></a>01234 
<a name="l01235"></a>01235 <span class="preprocessor">   #ifdef INTER_ANGLE</span>
<a name="l01236"></a>01236 <span class="preprocessor"></span>   <span class="comment">/*</span>
<a name="l01237"></a>01237 <span class="comment">   * Return the AngleFactory by reference.</span>
<a name="l01238"></a>01238 <span class="comment">   */</span>
<a name="l01239"></a>01239    <a class="code" href="classUtil_1_1Factory.html">Factory&lt;AnglePotential&gt;</a>&amp; Simulation::angleFactory()
<a name="l01240"></a>01240    {
<a name="l01241"></a>01241       <span class="keywordflow">if</span> (angleFactoryPtr_ == 0) {
<a name="l01242"></a>01242          angleFactoryPtr_ = <span class="keyword">new</span> <a class="code" href="classDdMd_1_1AngleFactory.html" title="Factory for AnglePotential objects.">AngleFactory</a>(*<span class="keyword">this</span>);
<a name="l01243"></a>01243       }
<a name="l01244"></a>01244       assert(angleFactoryPtr_);
<a name="l01245"></a>01245       <span class="keywordflow">return</span> *angleFactoryPtr_;
<a name="l01246"></a>01246    }
<a name="l01247"></a>01247 
<a name="l01248"></a>01248    <span class="comment">/*</span>
<a name="l01249"></a>01249 <span class="comment">   * Get the angle style string.</span>
<a name="l01250"></a>01250 <span class="comment">   */</span>
<a name="l01251"></a>01251    std::string Simulation::angleStyle()<span class="keyword"> const</span>
<a name="l01252"></a>01252 <span class="keyword">   </span>{  <span class="keywordflow">return</span> angleStyle_;  }
<a name="l01253"></a>01253 <span class="preprocessor">   #endif</span>
<a name="l01254"></a>01254 <span class="preprocessor"></span>
<a name="l01255"></a>01255 <span class="preprocessor">   #ifdef INTER_DIHEDRAL</span>
<a name="l01256"></a>01256 <span class="preprocessor"></span>   <span class="comment">/*</span>
<a name="l01257"></a>01257 <span class="comment">   * Return the DihedralFactory by reference.</span>
<a name="l01258"></a>01258 <span class="comment">   */</span>
<a name="l01259"></a>01259    <a class="code" href="classUtil_1_1Factory.html">Factory&lt;DihedralPotential&gt;</a>&amp; Simulation::dihedralFactory()
<a name="l01260"></a>01260    {
<a name="l01261"></a>01261       <span class="keywordflow">if</span> (dihedralFactoryPtr_ == 0) {
<a name="l01262"></a>01262          dihedralFactoryPtr_ = <span class="keyword">new</span> DihedralFactory(*<span class="keyword">this</span>);
<a name="l01263"></a>01263       }
<a name="l01264"></a>01264       assert(dihedralFactoryPtr_);
<a name="l01265"></a>01265       <span class="keywordflow">return</span> *dihedralFactoryPtr_;
<a name="l01266"></a>01266    }
<a name="l01267"></a>01267 
<a name="l01268"></a>01268    <span class="comment">/*</span>
<a name="l01269"></a>01269 <span class="comment">   * Get the dihedral style string.</span>
<a name="l01270"></a>01270 <span class="comment">   */</span>
<a name="l01271"></a>01271    std::string Simulation::dihedralStyle()<span class="keyword"> const</span>
<a name="l01272"></a>01272 <span class="keyword">   </span>{  <span class="keywordflow">return</span> dihedralStyle_;  }
<a name="l01273"></a>01273 <span class="preprocessor">   #endif</span>
<a name="l01274"></a>01274 <span class="preprocessor"></span>
<a name="l01275"></a>01275 <span class="preprocessor">   #ifdef INTER_EXTERNAL</span>
<a name="l01276"></a>01276 <span class="preprocessor"></span>   <span class="comment">/*</span>
<a name="l01277"></a>01277 <span class="comment">   * Return the ExternalFactory by reference.</span>
<a name="l01278"></a>01278 <span class="comment">   */</span>
<a name="l01279"></a>01279    <a class="code" href="classUtil_1_1Factory.html">Factory&lt;ExternalPotential&gt;</a>&amp; <a class="code" href="classDdMd_1_1Simulation.html#aa502eac2282707b7a8e6898f21cbf1ca" title="Get the associated External Factory by reference.">Simulation::externalFactory</a>()
<a name="l01280"></a><a class="code" href="classDdMd_1_1Simulation.html#aa502eac2282707b7a8e6898f21cbf1ca">01280</a>    {
<a name="l01281"></a>01281       <span class="keywordflow">if</span> (externalFactoryPtr_ == 0) {
<a name="l01282"></a>01282          externalFactoryPtr_ = <span class="keyword">new</span> <a class="code" href="classDdMd_1_1ExternalFactory.html" title="Factory for ExternalPotential objects.">ExternalFactory</a>(*<span class="keyword">this</span>);
<a name="l01283"></a>01283       }
<a name="l01284"></a>01284       assert(externalFactoryPtr_);
<a name="l01285"></a>01285       <span class="keywordflow">return</span> *externalFactoryPtr_;
<a name="l01286"></a>01286    }
<a name="l01287"></a>01287 
<a name="l01288"></a>01288    <span class="comment">/*</span>
<a name="l01289"></a>01289 <span class="comment">   * Get the external style string.</span>
<a name="l01290"></a>01290 <span class="comment">   */</span>
<a name="l01291"></a>01291    std::string <a class="code" href="classDdMd_1_1Simulation.html#aefa0323fdb3cab7a38db0b7f547c2c10" title="Return external potential style string.">Simulation::externalStyle</a>()<span class="keyword"> const</span>
<a name="l01292"></a><a class="code" href="classDdMd_1_1Simulation.html#aefa0323fdb3cab7a38db0b7f547c2c10">01292</a> <span class="keyword">   </span>{  <span class="keywordflow">return</span> externalStyle_;  }
<a name="l01293"></a>01293 <span class="preprocessor">   #endif</span>
<a name="l01294"></a>01294 <span class="preprocessor"></span>
<a name="l01295"></a>01295    <span class="comment">// Integrator and ConfigIo Management -------------------------------</span>
<a name="l01296"></a>01296    
<a name="l01297"></a>01297    <span class="comment">/*</span>
<a name="l01298"></a>01298 <span class="comment">   * Return the IntegratorFactory by reference.</span>
<a name="l01299"></a>01299 <span class="comment">   */</span>
<a name="l01300"></a>01300    <a class="code" href="classUtil_1_1Factory.html">Factory&lt;Integrator&gt;</a>&amp; <a class="code" href="classDdMd_1_1Simulation.html#a1466f5ccbcd070b984cf8602a5b8bb43" title="Get the Md integrator factory by reference.">Simulation::integratorFactory</a>()
<a name="l01301"></a><a class="code" href="classDdMd_1_1Simulation.html#a1466f5ccbcd070b984cf8602a5b8bb43">01301</a>    {
<a name="l01302"></a>01302       <span class="keywordflow">if</span> (integratorFactoryPtr_ == 0) {
<a name="l01303"></a>01303          integratorFactoryPtr_ = <span class="keyword">new</span> <a class="code" href="classDdMd_1_1IntegratorFactory.html" title="Factory for subclasses of Integrator (i.e., MD integrators).">IntegratorFactory</a>(*<span class="keyword">this</span>);
<a name="l01304"></a>01304       }
<a name="l01305"></a>01305       assert(integratorFactoryPtr_);
<a name="l01306"></a>01306       <span class="keywordflow">return</span> *integratorFactoryPtr_;
<a name="l01307"></a>01307    }
<a name="l01308"></a>01308 
<a name="l01309"></a>01309    <span class="comment">/*</span>
<a name="l01310"></a>01310 <span class="comment">   * Return the ConfigIoFactory by reference.</span>
<a name="l01311"></a>01311 <span class="comment">   */</span>
<a name="l01312"></a>01312    <a class="code" href="classUtil_1_1Factory.html">Factory&lt;ConfigIo&gt;</a>&amp; <a class="code" href="classDdMd_1_1Simulation.html#a7e41cb8e89401e39a90f4942a51c88d2" title="Get the configuration file reader/writer factory by reference.">Simulation::configIoFactory</a>()
<a name="l01313"></a><a class="code" href="classDdMd_1_1Simulation.html#a7e41cb8e89401e39a90f4942a51c88d2">01313</a>    {
<a name="l01314"></a>01314       <span class="keywordflow">if</span> (configIoFactoryPtr_ == 0) {
<a name="l01315"></a>01315          configIoFactoryPtr_ = <span class="keyword">new</span> <a class="code" href="classDdMd_1_1ConfigIoFactory.html" title="Default Factory for subclasses of ConfigIo.">ConfigIoFactory</a>(*<span class="keyword">this</span>);
<a name="l01316"></a>01316       }
<a name="l01317"></a>01317       assert(configIoFactoryPtr_);
<a name="l01318"></a>01318       <span class="keywordflow">return</span> *configIoFactoryPtr_;
<a name="l01319"></a>01319    }
<a name="l01320"></a>01320 
<a name="l01321"></a>01321    <span class="comment">/*</span>
<a name="l01322"></a>01322 <span class="comment">   * Set the ConfigIo, identified by subclass name.</span>
<a name="l01323"></a>01323 <span class="comment">   */</span>
<a name="l01324"></a>01324    <span class="keywordtype">void</span> <a class="code" href="classDdMd_1_1Simulation.html#aefaea5d3fe48d50291e0dbfcd4956737" title="Create a new configuration file reader/writer.">Simulation::setConfigIo</a>(std::string&amp; classname)
<a name="l01325"></a><a class="code" href="classDdMd_1_1Simulation.html#aefaea5d3fe48d50291e0dbfcd4956737">01325</a>    {
<a name="l01326"></a>01326       <a class="code" href="classDdMd_1_1ConfigIo.html" title="Abstract reader/writer for configuration files.">ConfigIo</a>* ptr = configIoFactory().factory(classname);
<a name="l01327"></a>01327       <span class="keywordflow">if</span> (!ptr) {
<a name="l01328"></a>01328          <a class="code" href="global_8h.html#ad2512f8bd062d41d66799cf900151487" title="Macro for throwing an Exception, reporting function, file and line number.">UTIL_THROW</a>(<span class="stringliteral">&quot;Unrecognized ConfigIo subclass name&quot;</span>);
<a name="l01329"></a>01329       } 
<a name="l01330"></a>01330       <span class="keywordflow">if</span> (configIoPtr_) {
<a name="l01331"></a>01331          <span class="keyword">delete</span> configIoPtr_;
<a name="l01332"></a>01332       }
<a name="l01333"></a>01333       configIoPtr_ = ptr;
<a name="l01334"></a>01334       configIoPtr_-&gt;<a class="code" href="classDdMd_1_1ConfigIo.html#a36fdd33b4d149bc67aaf1ac3fede6a8f" title="Associate with related objects.">associate</a>(domain_, boundary_,
<a name="l01335"></a>01335                               atomStorage_, bondStorage_, 
<a name="l01336"></a>01336                               #ifdef INTER_ANGLE
<a name="l01337"></a>01337                               angleStorage_,
<a name="l01338"></a>01338                               #endif
<a name="l01339"></a>01339                               #ifdef INTER_DIHEDRAL
<a name="l01340"></a>01340                               dihedralStorage_,
<a name="l01341"></a>01341                               #endif
<a name="l01342"></a>01342                               buffer_);
<a name="l01343"></a>01343       configIoPtr_-&gt;initialize();
<a name="l01344"></a>01344    }
<a name="l01345"></a>01345 
<a name="l01346"></a>01346    <span class="comment">// Validation ------------------------------------------------------</span>
<a name="l01347"></a>01347    
<a name="l01351"></a>01351    <span class="keywordtype">bool</span> <a class="code" href="classDdMd_1_1Simulation.html#ae1fec95c5c1fa9948ab3e7e5425e35c2" title="Return true if this Simulation is valid, or throw an Exception.">Simulation::isValid</a>()
<a name="l01352"></a><a class="code" href="classDdMd_1_1Simulation.html#ae1fec95c5c1fa9948ab3e7e5425e35c2">01352</a>    {
<a name="l01353"></a>01353 <span class="preprocessor">      #ifdef UTIL_MPI</span>
<a name="l01354"></a>01354 <span class="preprocessor"></span>      atomStorage_.isValid(domain_.communicator());
<a name="l01355"></a>01355 <span class="preprocessor">      #else</span>
<a name="l01356"></a>01356 <span class="preprocessor"></span>      atomStorage_.isValid();
<a name="l01357"></a>01357 <span class="preprocessor">      #endif</span>
<a name="l01358"></a>01358 <span class="preprocessor"></span>
<a name="l01359"></a>01359       <span class="comment">// Determine if there are any ghosts on any processor</span>
<a name="l01360"></a>01360       <span class="keywordtype">int</span> nGhost = atomStorage_.nGhost();
<a name="l01361"></a>01361       <span class="keywordtype">int</span> nGhostAll = 0;
<a name="l01362"></a>01362 <span class="preprocessor">      #ifdef UTIL_MPI</span>
<a name="l01363"></a>01363 <span class="preprocessor"></span>      domain_.communicator().Reduce(&amp;nGhost, &amp;nGhostAll, 1, 
<a name="l01364"></a>01364                                     MPI::INT, MPI::SUM, 0);
<a name="l01365"></a>01365       <a class="code" href="namespaceUtil.html#a17692180f6c210c0746958d9a336d02b" title="Broadcast a C-array of T objects.">bcast</a>(domain_.communicator(), nGhostAll, 0);
<a name="l01366"></a>01366 <span class="preprocessor">      #else</span>
<a name="l01367"></a>01367 <span class="preprocessor"></span>      nGhostAll = nGhost;
<a name="l01368"></a>01368 <span class="preprocessor">      #endif</span>
<a name="l01369"></a>01369 <span class="preprocessor"></span>      <span class="keywordtype">bool</span> hasGhosts = bool(nGhostAll);
<a name="l01370"></a>01370 
<a name="l01371"></a>01371       <span class="comment">// Test Group storage containers</span>
<a name="l01372"></a>01372 <span class="preprocessor">      #ifdef UTIL_MPI</span>
<a name="l01373"></a>01373 <span class="preprocessor"></span>      bondStorage_.isValid(atomStorage_, domain_.communicator(), hasGhosts);
<a name="l01374"></a>01374 <span class="preprocessor">      #ifdef INTER_ANGLE</span>
<a name="l01375"></a>01375 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nAngleType_) {
<a name="l01376"></a>01376          angleStorage_.isValid(atomStorage_, domain_.communicator(), hasGhosts);
<a name="l01377"></a>01377       }
<a name="l01378"></a>01378 <span class="preprocessor">      #endif</span>
<a name="l01379"></a>01379 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_DIHEDRAL</span>
<a name="l01380"></a>01380 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nDihedralType_) {
<a name="l01381"></a>01381          dihedralStorage_.isValid(atomStorage_, domain_.communicator(), 
<a name="l01382"></a>01382                                   hasGhosts);
<a name="l01383"></a>01383       }
<a name="l01384"></a>01384 <span class="preprocessor">      #endif</span>
<a name="l01385"></a>01385 <span class="preprocessor"></span><span class="preprocessor">      #else // ifdef UTIL_MPI</span>
<a name="l01386"></a>01386 <span class="preprocessor"></span>      bondStorage_.isValid(atomStorage_, hasGhosts);
<a name="l01387"></a>01387 <span class="preprocessor">      #ifdef INTER_ANGLE</span>
<a name="l01388"></a>01388 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nAngleType_) {
<a name="l01389"></a>01389          angleStorage_.isValid(atomStorage_, hasGhosts);
<a name="l01390"></a>01390       }
<a name="l01391"></a>01391 <span class="preprocessor">      #endif</span>
<a name="l01392"></a>01392 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_DIHEDRAL</span>
<a name="l01393"></a>01393 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nDihedralType_) {
<a name="l01394"></a>01394          dihedralStorage_.isValid(atomStorage_, hasGhosts);
<a name="l01395"></a>01395       }
<a name="l01396"></a>01396 <span class="preprocessor">      #endif</span>
<a name="l01397"></a>01397 <span class="preprocessor"></span><span class="preprocessor">      #endif // ifdef UTIL_MPI</span>
<a name="l01398"></a>01398 <span class="preprocessor"></span>
<a name="l01399"></a>01399       <span class="comment">// Test consistency of computed potential energies and stresses</span>
<a name="l01400"></a>01400 <span class="preprocessor">      #ifdef UTIL_MPI</span>
<a name="l01401"></a>01401 <span class="preprocessor"></span>      pairPotentialPtr_-&gt;isValid(domain_.communicator());
<a name="l01402"></a>01402       bondPotentialPtr_-&gt;isValid(domain_.communicator());
<a name="l01403"></a>01403 <span class="preprocessor">      #ifdef INTER_ANGLE</span>
<a name="l01404"></a>01404 <span class="preprocessor"></span>      anglePotentialPtr_-&gt;isValid(domain_.communicator());
<a name="l01405"></a>01405 <span class="preprocessor">      #endif</span>
<a name="l01406"></a>01406 <span class="preprocessor"></span><span class="preprocessor">      #ifdef INTER_DIHEDRAL</span>
<a name="l01407"></a>01407 <span class="preprocessor"></span>      dihedralPotentialPtr_-&gt;isValid(domain_.communicator());
<a name="l01408"></a>01408 <span class="preprocessor">      #endif</span>
<a name="l01409"></a>01409 <span class="preprocessor"></span><span class="preprocessor">      #endif // ifdef UTIL_MPI</span>
<a name="l01410"></a>01410 <span class="preprocessor"></span>
<a name="l01411"></a>01411       <span class="keywordflow">return</span> <span class="keyword">true</span>; 
<a name="l01412"></a>01412    }
<a name="l01413"></a>01413 
<a name="l01414"></a>01414 }
<a name="l01415"></a>01415 <span class="preprocessor">#endif</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Fri Aug 31 2012 22:41:03 for Simpatico by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </small></address>
</body>
</html>
