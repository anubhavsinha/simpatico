<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Simpatico: Makefiles</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Simpatico&#160;<span id="projectnumber">v1.0</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="index.html">Simpatico - Simulation Package for Polymer and Molecular Liquids</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>Makefiles </h1>  </div>
</div>
<div class="contents">
<div class="textblock"><p>Simpatico is compiled using a system of unix makefiles. All development was done using gnu make (gmake), and so the makefiles may contain syntax that does not work with other variants of make (we have never checked).</p>
<p>All of the header (*.h) and source (*.cpp) files for Simpatico are in subdirectories of the src/ directory. The header and source file for each class are in the same directory. The name of each such file is the same as the class name, followed by the extension .h or .cpp. All class names and corresponding file base names are upper space camel (like <a class="el" href="classUtil_1_1Vector.html" title="A Vector is a Cartesian vector.">Util::Vector</a> or <a class="el" href="classMcMd_1_1FileMaster.html" title="A FileMaster manages a set of input and output files.">McMd::FileMaster</a>). When each source file is compiled, the resulting object (*.o) file is placed in the same directory as the source file, using the same base name, with a .o extension. When automatic dependency generation is enabled, a dependency file with a suffix *.d is also created for each source file as a side effect of compilation.</p>
<p>The src/util, src/inter, src/mcMd, and src/ddMd directories each contain the code for a different C++ namespace: src/util/ contains all code in the <a class="el" href="namespaceUtil.html" title="Utility classes for scientific computation.">Util</a> namespace, src/inter/ contains all code in the <a class="el" href="namespaceInter.html" title="Classes that define potential energy interaction functions.">Inter</a> namespace, src/mcMd contains the <a class="el" href="namespaceMcMd.html" title="Classes for Monte Carlo (MC) and molecular dynamics (MC) simulation.">McMd</a> namespace, and src/ddMd contains the <a class="el" href="namespaceDdMd.html" title="Parallel domain decomposition (DD) molecular dynamics MD simulation.">DdMd</a> namespace. These four directories will thus be referred to in what follows as "namespace" level directories.</p>
<h2><a class="anchor" id="make_main"></a>
Main makefile</h2>
<p>The file src/makefile is the main makefile. It has two main makefile targets, "mcMd" and "ddMd". The "mcMd" target builds the mcSim and mdSim executable. The "ddMd" target builds the ddSim parallel MD executable.</p>
<p>Entering "make mcMd" from the src/ directory will:</p>
<ul>
<li>Compile all of the source (*.cpp) files in the util/, inter/, and mcMd/ subdirectories, creating corresponding object (*.o) files,</li>
</ul>
<ul>
<li>Construct three static library (*.a) files from the resulting object files, each of which contains the code from one namespace.</li>
</ul>
<ul>
<li>Compile the programs <a class="el" href="mcSim_8cpp_source.html">src/mcMd/mcSim.cpp</a> and <a class="el" href="mdSim_8cpp_source.html">src/mcMd/mdSim.cpp</a>, and link them with three libraries to create a pair of executable programs for MC and MD simulation.</li>
</ul>
<p>By default, the resulting library files are placed in the simpatico/lib/ directory, and the executable files are placed in the simpatico/bin/ directory.</p>
<p>Entering "make ddMd" from the src/ directory instead compiles (or recompiles) all of the source code from the util/, inter/, and ddMd/ directories, creates three corresponding library files in simpatico lib/ directory, and creates an executable (by default) named ddSim in the simpatico/bin directory.</p>
<p>The "mcMd" annd "ddMd" targets of the main src/makefile both use recursive make: The commands associated with these targets descend into to each of the required subdirectories of src/ and invoke "make all" from within each such subdirectory.</p>
<h2><a class="anchor" id="make_namespace"></a>
Subdirectory Makefiles</h2>
<p>Each of the namespace level directories src/util, src/inter, src/mcMd and src/ddMd has a makefile with an "all" target that compiles all of the source code in the associated directory tree, or in the associated namespace. Invoking "make all" from any namepspace level directory also builds an associated static library that contains compiled object code for all of the classes in that namespace.</p>
<p>The makefiles in the src/mcMd and src/ddMd directories also build executables. Invoking "make all" from src/mcMd compiles the main programs <a class="el" href="mcSim_8cpp_source.html">src/mcMd/mcSim.cpp</a> and <a class="el" href="mdSim_8cpp_source.html">src/mcMd/mdSim.cpp</a> and builds the mcSim and mdSim executables. Invoking "make all" from src/ddMd compiles <a class="el" href="ddSim_8cpp_source.html">src/ddMd/ddSim.cpp</a> and builds the ddSim executable.</p>
<p>Each subdirectory in the directory trees rooted at the four namespace level directories also has a makefile very similar to those in the namespace level makefiles. The makefile in each such directory has an "all" target that compiles all of the class source files in the sub-tree rooted at the directory that contains the makefile.</p>
<p>Each the namespace level directories has fragments named "patterns.mk", "sources.mk" and "defines.mk". These are included in the namespace level makefiles, as well as in subdirectory makefiles. The "patterns.mk" file in each namespace level directory defines a makefile pattern rule that is used to compile all of the class source files the associated namespace. The "sources.mk" makefile in a namespace level directory defines makefile variables that list all of the class source (*.cpp) and object (*.o) files in that namespace. The defines.mk file can be used to define preprocessor macros that effect the code in that namespace.</p>
<p>Each of the makefiles in the namespace level directories and their subdirectories includes the src/compiler.mk file, the appropriate namespace level patterns.mk file, and one or more namespace level defines.mk and sources.mk files. The logic of which files are included is based on which namespaces depend on others. A namespace A will be said to depend on another namespace B if any of the code in A uses symbols (e.g., classes) that are defined in B. The <a class="el" href="namespaceUtil.html" title="Utility classes for scientific computation.">Util</a> namespace does not depend on any of the other three namespaces. The <a class="el" href="namespaceInter.html" title="Classes that define potential energy interaction functions.">Inter</a> namespace depends on the <a class="el" href="namespaceUtil.html" title="Utility classes for scientific computation.">Util</a> namespace. The <a class="el" href="namespaceMcMd.html" title="Classes for Monte Carlo (MC) and molecular dynamics (MC) simulation.">McMd</a> namespace depends on the <a class="el" href="namespaceUtil.html" title="Utility classes for scientific computation.">Util</a> and <a class="el" href="namespaceInter.html" title="Classes that define potential energy interaction functions.">Inter</a> namespace, but not on the <a class="el" href="namespaceDdMd.html" title="Parallel domain decomposition (DD) molecular dynamics MD simulation.">DdMd</a> namespace. The <a class="el" href="namespaceDdMd.html" title="Parallel domain decomposition (DD) molecular dynamics MD simulation.">DdMd</a> namespace, depends on the <a class="el" href="namespaceUtil.html" title="Utility classes for scientific computation.">Util</a> and <a class="el" href="namespaceInter.html" title="Classes that define potential energy interaction functions.">Inter</a> namespaces, but not on the <a class="el" href="namespaceMcMd.html" title="Classes for Monte Carlo (MC) and molecular dynamics (MC) simulation.">McMd</a> namespace. The makefiles in the directory tree associated with a namespace all include the defines.mk and sources.mk files from the namespace level directories associated with that namespace and with all of the namespaces upon which that namespace depends. As a result: Makefiles in the util/ directory tree include only the defines.mk and sources.mk files from the src/util directory. Makefiles in the inter/ directory tree include defines.mk and sources.mk files from the src/util and src/inter directories. Makefiles in the mcMd/ directory tree include defines.mk and sources.mk files from the util/, inter/ and mcMd/ directories. Those in the ddMd/ directory tree include defines.mk and sources.mk files from the util/, inter/ and ddMd/ directories.</p>
<h2><a class="anchor" id="make_sources"></a>
Subdirectory sources.mk files</h2>
<p>The "sources.mk" file in each directory at the namespace level and below defines a pair of variables that list all of the source and object files for that directory and all of its subdirectories. Each such file defines two variables with names of the form [directory]_SRCS and [directory]_OBJS. Here, [directory] represents a mangled form of the directory name. The mangled directory name is constructed by taking the path from the src/ directory to the subdirectory of interest and replacing each "/" directory separator by an underscore ("_"). Thus for example, the file src/util/param/sources.mk defines variables util_param_SRCS and util_param_OBJS. The sources.mk in the namespace level directory src/util instead defines variables util_SRCS and util_OBJS.</p>
<p>In each such directory, the value of [directory]_SRCS is a list of paths to the all of the source (*.cpp) files in the directory tree rooted at the directory. The value of [directory]_OBJS variable is a list of the paths for all of the corresponding *.o object files. Thus, for example, the file src/util/sources.mk defines variables util_SRCS, and util_OBJS that contain lists of the names of all of the source files and and object file targets in the util/ directory and its subdirectories.</p>
<p>These lists of source files are constructed recursively, by concatenating corresponding lists defined in subdirectories. In each source code directory that contains subdirectories, the value of the [directory]_SRCS variable is constructed by including the "sources.mk" files from all subdirectories, concatenating values of the [subdirectory]_SRCS variables defined in those subdirectories, and then adding paths for any source files in the parent directory. Please take a look at a few sources.mk files to see how this works.</p>
<p>The [directory]_OBJS variable in each sources.mk file is then defined using a substitution pattern that simply replaces the suffix *.cpp by *.o for every file in the corresponding [directory]_SRCS file. For example, in the file src/util/sources.mk, util_OBJS is defined by the pattern </p>
<div class="fragment"><pre class="fragment">util_OBJS=$(util_SRCS:.cpp=.o)
</pre></div><p>To add a source file to the makefile system, one must simply add the path to the source file in the sources.mk file in the directory that contains the new source file. The path to the each source file should be given as an absolute path in which the simpatico/src directory is represented using the variable . Adding the path to a source file to the [directory]_SRCS variable in the directory that contains the source file is enough to guarantee that it will be added to the corresponding variables in all parent directories, up to the namespace level directories.</p>
<p>The "all" target in each directory builds all of the object files listed in the [directory]_OBJS variable for that directory. Entering "make all" from any directory at the namespace level or below will thus compile all of the object files in that directory and all of its subdirectories. The make all targets for the namespace level makefile also create libraries and (in some cases) executables.</p>
<h2><a class="anchor" id="make_dependency"></a>
Dependency Files</h2>
<p>When automatic dependency generation is enabled, a dependency file will be generated for each source file. Each dependency file is generated as a side-effect of compilation, as dictated by the compilation patterns given in the namespace level patterns.mk files. The dependency file associated with a source file has the same base name as the source file, with an extension .d rather than *.cpp, and is placed in the same directory as the source and object files.</p>
<p>Each such dependency file defines a single makefile rule for creating the corresponding object (*.o) file target. The rule consists of the name of the target *.o followed by a colon and list of files upon which it depends, of the form </p>
<div class="fragment"><pre class="fragment"><span class="keyword">class</span>.o: <span class="keyword">class</span>.cpp <span class="keyword">class</span>.h header1.h header2.h ....
</pre></div><p> This list of depenencies includes both the source file class.cpp and all of the header files that this source file directly or indirectly includes. The commands required to construct an object target is not specified explicitly in this makefile rule, but is instead defined implicitly by a pattern rule defined in the namespace level patterns.mk file.</p>
<p>In each makefile at the namespace level and below, a list of dependency files for individual *.o object files is included into the makefile by a command of the form </p>
<div class="fragment"><pre class="fragment">-include $([directory]_OBJS:.o=.d)
</pre></div><p> in which [directory] represents the mangled name of the directory containing the makefile. For example, in the file src/mcMd/mdSimulation, this line is </p>
<div class="fragment"><pre class="fragment">-include $(mcMd_mdSimulation_OBJS:.o=.d)
</pre></div><p> This line attempts to include all of the *.d dependency files corresponding to *.o object files in the directory tree rooted at this directory. Because each such dependency file contains a makefile rule for one object file target, this automatically generates a list of makefile rules for all object files in the tree rooted at this directory. The dash in front of "include" instructs "make" to continue quietly if no dependency file is found for any of the object files listed in [directory]_OBJS variable.</p>
<p>If automatic dependency generation is enabled, dependency files are created as a side-effect of compilation, using the executable script bin/makeDep. The pattern rules defined in the namespace level patterns.mk files apply the makeDep script to a source file whenever that file is compiled, and thereby regenerate the associated dependency file. The "makeDep" script works by calling the gnu g++ compiler with the -MM option to calculate dependencies, and then editing the resulting file to modify the form of the paths for the target and dependency.</p>
<h2><a class="anchor" id="make_paths"></a>
Source File Paths</h2>
<p>All file paths in sources.mk files are specified as absolute paths by using the makefile variable  to represent the absolute path to the src/ directory, and adding the relative path from the src/ directory to source file of interest. For example, the path to src/util/math/Vector.cpp is given in src/util/math/sources.mk as </p>
<div class="fragment"><pre class="fragment">   $(SRC_DIR)/util/math/Vector.cpp
</pre></div><p> The variable SRC_DIR must be set equal to the absolute path to the src/ directory in the file src/compiler.mk, which is then included in every other makefile. The correct value for this path should be set by the ./configure script during initial configuration.</p>
<p>After substituting the value of , every source file path in every sources.mk file expands to an absolute path. All paths for the targets and dependencies within the *.d dependency files are also expressed as absolute paths. In the sources.mk files, the absolute paths are expressed in in terms of a variable  because the sources.mk files are stored in the repository and distributed with Simpatico, and thus must express file paths in a portable form. The dependency files can instead use literal absolute paths because these files are generated by user as a side-effect of compilation, rather than being stored in the repository, and thus need not be expressed in a portable form.</p>
<p>When automatic dependency generation is enabled, entering "make all" from any directory at the namespace level or below will cause recompilation of all source files in the tree rooted at that directory that been modified or that include header files that have been modified since the source file was last compiled. If a developer is working on one or two classes in a directory, invoking "make all" from that directory will normally recompile only the classes that are being worked on. If "make all" fails when you are working on one class because one more other classes in the same directory are broken, compilation of the broken classes can be temporarily suppressed by commenting them out of the list of source files listed in the value of the [directory]_SRCS variable in the source.mk file in that directory.</p>
<h2><a class="anchor" id="make_single"></a>
How to compile a single source file</h2>
<p>Because the Simpatico build system uses absolute paths for all source files, and because the make program is not smart enough to recognize the equivalence of absolute and relative paths, the only way to explicitly compile a single source file is to use the absolute path to the object file as a makefile target, as in </p>
<div class="fragment"><pre class="fragment">make /home/george/simpatico/src/mcMd/simulation/Simulation.o
</pre></div><p> This is to much of a nuisance for most programmers. If you want to compile a file that you are working on, it is more convenient to just enter "make all" from the directory containing that file. If automatic dependency generation is enabled, and if you are working on only one file in that directory at a time, this will cause the make system to compile only the file that you just modified.</p>
<p>This way of working does require that you comment broken or or unfinished source files out of the *_SRCS list in the sources.mk file until you are ready to fix them. Otherwise, entering "make all" will try to compile files that may not yet be compilable.</p>
<ul>
<li>
<a class="el" href="developer_page.html">Developer Information</a> (Up)  </li>
<li>
<a class="el" href="test_page.html">Unit Tests</a> (Next)  </li>
</ul>
</div></div>
<hr class="footer"/><address class="footer"><small>Generated on Wed Jul 4 2012 00:11:21 for Simpatico by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </small></address>
</body>
</html>
